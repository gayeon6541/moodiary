<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MOODIARY – Today</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/static/pretendard.css"
        crossorigin>
    <style>
        @font-face {
            font-family: 'HsBombaram30';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10@1.1/HSBombaram3_Thin.woff') format('woff');
            font-weight: 100;
            font-display: swap
        }

        @font-face {
            font-family: 'HsBombaram30';
            src: url('https://gcore.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10@1.1/HSBombaram3_Regular.woff') format('woff');
            font-weight: 400;
            font-display: swap
        }

        @import url('https://fonts.googleapis.com/css2?family=IM+Fell+Double+Pica+SC&display=swap');

        :root {
            --ink: #111;
            --muted: #666;
            --bg: #fff;
            --header-h: 72px;
            --gap: 14px;
            --side: clamp(16px, 4vw, 60px);
            --content-max: 1440px;
            --border-w: .5px;
            --line: #111;
            --radius: 0;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        /* 전체 한 화면, 스크롤 제거 */

        body {
            background: var(--bg);
            color: var(--ink);
            font-family: Pretendard, system-ui, -apple-system, BlinkMacSystemFont, Inter, sans-serif;
            line-height: 1.55;
            cursor: none;
        }

        header.site {
            position: sticky;
            top: 0;
            z-index: 50;
            height: var(--header-h);
            background: rgba(255, 255, 255, .9);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid #eaeaea
        }

        .wrap {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 var(--side)
        }

        .bar {
            height: var(--header-h);
            display: grid;
            gap: 10px;
            grid-template-columns: 140px 1fr auto auto;
            align-items: center
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit
        }

        .brand img {
            width: 40px;
            height: 40px;
            display: block;
            animation: float 2.4s ease-in-out infinite
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-5px)
            }
        }

        nav.main {
            display: flex;
            justify-content: flex-end;
            gap: 22px
        }

        nav.main a {
            position: relative;
            text-decoration: none;
            color: var(--ink);
            padding: 4px 2px;
            font-weight: 500
        }

        nav.main a::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: -6px;
            height: 2px;
            background: currentColor;
            transform: scaleX(0);
            transform-origin: 0 50%;
            transition: transform .25s
        }

        nav.main a:hover::after {
            transform: scaleX(1)
        }

        .sound {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--muted);
            margin-left: clamp(10px, 1.2vw, 18px)
        }

        .sound button {
            border: 1.25px solid #000;
            border-radius: 0;
            background: #fff;
            padding: 8px 12px;
            cursor: pointer;
            transition: background .25s ease, color .25s ease
        }

        .sound button:hover {
            background: #000;
            color: #fff
        }

        .viewport {
            min-height: calc(100vh - var(--header-h));
            display: grid;
            grid-template-rows: auto 1fr;
            padding-bottom: 0
        }

        .page {
            padding: 0 var(--side)
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: calc(100vh - var(--header-h));
            position: relative;

            /* 한 장짜리 배경 */
            background: url("img/book.svg") center/100% 100% no-repeat;
        }



        @media (max-width:1024px) {
            .grid-2 {
                grid-template-columns: 1fr
            }
        }

        /* 패널 공통 */
        .panel {
            display: flex;
            flex-direction: column;
            width: 100%
        }

        .panel-header {
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px
        }

        .panel-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: .1px
        }

        .left,
        .right {
            display: flex
        }

        /* 좌우 패널 여백/높이 정리 */
        .left .panel,
        .right .panel {
            position: relative;
            height: calc(100% - 100px);
            margin: 50px;
            display: flex;
            flex-direction: column;

            /* 배경 이미지 꽉 채우기 (잘림 없음, 왜곡 가능) */
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* LEFT — 카드 프리뷰 영역 */
        .left .panel-body {
            overflow: hidden
        }

        /* 카드+설명 묶음을 중앙 정렬 */
        .preview {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }


        .card-set {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* 카드와 설명을 함께 중앙 정렬 */
            gap: 20px;
            /* 카드와 설명 간격 */
        }

        .card {
            margin-top: 0%;
            /* 원하는 만큼 조절 */
            width: min(340px, 90%);
            aspect-ratio: 2/3;
            border: var(--border-w) solid var(--line);
            padding: 16px 10px 83px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            border-radius: 0;
            position: relative;
            z-index: 2;
            /* 설명보다 위에 고정 */
        }

        .card-art {
            border: var(--border-w) solid var(--line);
            position: relative;
            flex: 1 1 auto;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #flowerImg {
            display: none;
            max-width: 50vw;
            /* 화면 절반 정도 크기 */
            max-height: 70vh;
            /* 세로 크게 */
            object-fit: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #flowerImg.big {
            display: block;
        }


        .overlay-prop {
            position: absolute;
            width: 34%;
            opacity: .95;
            pointer-events: none
        }

        .overlay-prop.prop-0 {
            left: 4%;
            bottom: 6%
        }

        .overlay-prop.prop-1 {
            right: 4%;
            top: 8%
        }

        .card-title {
            margin: 0;
            font-size: clamp(18px, 4.6vw, 26px);
            font-weight: 800;
            letter-spacing: .8px;
            font-family: ui-serif, "Times New Roman", Georgia, serif
        }

        .card-quote {
            width: 100%;
            min-height: 44px;
            padding: 10px 12px;
            text-align: center;
            color: #2a2a2a;
            font-size: 14px;
            font-style: italic;
            letter-spacing: .1px
        }

        .card-sub {
            color: #5a5a5a;
            font-size: clamp(12px, 2.6vw, 14px);
            letter-spacing: .2px
        }

        /* 설명 박스는 absolute 제거 → 자연스럽게 카드 밑에 위치 */
        .desc-box {
            position: static;
            margin-top: 16px;
            /* 카드와 간격 */
            width: min(440px, 92%);
            max-height: 120px;
            overflow: auto;
            padding: 12px 14px;
            background: rgba(255, 255, 255, .92);
            backdrop-filter: blur(4px);
            border-radius: 4px;
        }

        .desc-text {
            margin: 0;
            color: #333;
            line-height: 1.7;
            font-size: 14px;
            white-space: pre-line
        }

        /* RIGHT — 스텝 묶음 중앙 정렬 */
        #stepsScroll {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(860px, 92%);
            max-height: calc(100% - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .step-block {
            width: 100%;
            padding: 16px;
            border-radius: 0;
            margin: 10px 0
        }

        .s1-title {
            font-size: 18px;
            font-weight: 500;
            letter-spacing: -.01em;
            margin: 6px 0 14px
        }

        .s1-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap
        }

        .s1-field {
            border: var(--border-w) solid var(--line);
            padding: 10px 12px;
            width: min(580px, 90vw)
        }

        .s1-field input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 15px;
            background: transparent
        }

        .grid {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(4, minmax(0, 1fr))
        }

        @media (max-width:740px) {
            .grid {
                grid-template-columns: repeat(2, minmax(0, 1fr))
            }
        }

        .chip {
            border: var(--border-w) solid var(--line);
            padding: 10px 12px;
            border-radius: 0;
            cursor: pointer;
            text-align: center;
            transition: transform .12s, box-shadow .12s, background .12s, color .12s
        }

        .chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0, 0, 0, .08)
        }

        .chip.active {
            background: #111;
            color: #fff;
            border-color: #111
        }

        button,
        .btn {
            border: var(--border-w) solid var(--line);
            border-radius: 0;
            padding: 10px 16px;
            font-weight: 400;
            cursor: pointer;
            transition: background .2s, color .2s, transform .1s
        }

        button:hover,
        .btn:hover {
            background: #000;
            color: #fff
        }

        button:active {
            transform: translateY(1px)
        }

        /* 커서/배경 */
        .flower-cursor {
            position: fixed;
            left: 0;
            top: 0;
            z-index: 9999;
            pointer-events: none;
            user-select: none;
            width: 40px;
            height: 40px;
            display: grid;
            place-items: center;
            font-size: 24px;
            line-height: 1;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, .12))
        }

        .flower-cursor::before {
            content: "";
            position: absolute;
            inset: 0;
            border: 2px solid #111;
            border-radius: 999px;
            box-sizing: border-box
        }

        .flower-cursor.active {
            font-size: 26px
        }

        .background-decor {
            position: fixed;
            inset: 0;
            overflow: hidden;
            z-index: -1
        }

        .butterfly {
            position: absolute;
            width: 80px;
            height: auto;
            animation: flutter 6s ease-in-out infinite;
            opacity: .85
        }

        @keyframes flutter {

            0%,
            100% {
                transform: translateY(0) rotate(0deg)
            }

            50% {
                transform: translateY(-20px) rotate(10deg)
            }
        }

        /* 왼쪽 패널을 그리드 중앙 정렬 컨테이너로 */
        .left .panel-body {
            display: grid;
            place-items: center;
            height: 100%;
            padding: 0;
        }

        /* 이미지: 왼쪽 그리드 안에서 '살짝 크게' */
        #flowerImg {
            display: none;
            /* 선택 전 숨김 */
            position: static;
            /* absolute 제거 */
            transform: none;

            max-width: clamp(360px, 46vw, 620px);
            max-height: clamp(320px, 60vh, 720px);
            width: auto;
            height: auto;
            object-fit: contain;
        }

        #flowerImg.big {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="site">
        <div class="wrap">
            <div class="bar">
                <a class="brand" href="index.html" aria-label="MOODIARY Home">
                    <img src="img/sub-flower.svg" alt="MOODIARY 로고"><span>MOODIARY</span>
                </a>
                <div></div>
                <nav class="main" aria-label="Main">
                    <a href="today-loding.html" class="active">Today</a>
                    <a href="diary-loding.html">Diary</a>
                    <a href="flower-loding.html">Flower</a>
                </nav>
                <div class="sound">
                    <button id="soundToggle" aria-pressed="false">🔊 Sound (On)</button>
                    <audio id="bgm" preload="auto" autoplay loop playsinline src="audio/temp.mp3"></audio>
                </div>
            </div>
        </div>
    </header>

    <div class="viewport">
        <main class="page">
            <div class="grid-2">
                <!-- LEFT -->
                <section class="left">
                    <div class="panel">
                        <!-- ✅ 복구 -->
                        <div class="panel-body">
                            <!-- 가운데 정렬 컨테이너 -->
                            <img id="flowerImg" alt="">
                        </div>
                    </div>
                </section>

                <!-- RIGHT -->
                <section class="right">
                    <div class="panel">
                        <div class="progress-flowers" id="progressFlowers" aria-label="진행 단계">
                            <!-- (아이콘들은 필요 시 채워 사용) -->
                        </div>
                        <div class="panel-body" id="stepsScroll">
                            <!-- STEP 1 -->
                            <section class="step-block" id="step-1">
                                <h2 class="s1-title">오늘 하루, 어떤 기분이었나요?</h2>
                                <div class="s1-row">
                                    <label class="s1-field"><input id="moodInput" type="text" maxlength="60"
                                            placeholder="ex) 오늘은 마음이 울적한 기분이야." autocomplete="off" /></label>
                                </div>
                            </section>
                            <!-- STEP 2 -->
                            <section class="step-block" id="step-2">
                                <h2 class="s1-title">문장과 어울리는 감정 키워드를 고르세요.</h2>
                                <div class="grid" id="keywordGrid"></div>
                            </section>
                            <!-- STEP 3 -->
                            <section class="step-block" id="step-3">
                                <h2 class="s1-title">감정에 어울리는 날씨를 1개 골라 꾸며주세요.</h2>
                                <div class="grid" id="propGrid"></div>
                            </section>
                            <!-- STEP 4 -->
                            <section class="step-block" id="step-4">
                                <div class="toolbar"
                                    style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
                                    <button id="goDiaryBtn" type="button">다이어리로 이동 →</button>
                                    <button id="saveToday" class="primary" type="button">저장하고 날짜로 돌아가기</button>
                                </div>
                            </section>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div class="background-decor" id="backgroundDecor"></div>

    <script>
        function stampCardTime(date) { const store = readTodayStore(); const prev = store[date] || { date }; prev.cardCreatedAt = Date.now(); store[date] = prev; writeTodayStore(store); }

        /* BGM */
        (function () {
            const audio = document.getElementById('bgm'), btn = document.getElementById('soundToggle');
            const STATE_KEY = 'moodiary_bgm_state', POS_KEY = 'moodiary_bgm_pos', VOL_KEY = 'moodiary_bgm_vol';
            function setBtn(on) { btn.textContent = on ? '🔊 Sound (On)' : '🔈 Sound (Off)'; btn.setAttribute('aria-pressed', on) }
            const fps = 60;
            function fadeTo(target = .35, ms = 800) {
                target = Math.max(0, Math.min(1, target));
                const step = (target - audio.volume) / (ms / (1000 / fps));
                const t = setInterval(() => {
                    audio.volume = Math.max(0, Math.min(1, audio.volume + step));
                    if ((step > 0 && audio.volume >= target) || (step < 0 && audio.volume <= target)) { clearInterval(t); localStorage.setItem(VOL_KEY, String(audio.volume)); }
                }, 1000 / fps);
            }
            async function tryPlay() {
                try { audio.muted = false; audio.volume = parseFloat(localStorage.getItem(VOL_KEY) || '0.30'); await audio.play(); setBtn(true); fadeTo(parseFloat(localStorage.getItem(VOL_KEY) || '0.35'), 700); }
                catch { setBtn(false); const unlock = async () => { try { await audio.play(); setBtn(true); fadeTo(parseFloat(localStorage.getItem(VOL_KEY) || '0.35'), 700); } catch { } finally { window.removeEventListener('pointerdown', unlock, { once: true }); } }; window.addEventListener('pointerdown', unlock, { once: true }); }
            }
            audio.addEventListener('loadedmetadata', () => {
                const pos = parseFloat(localStorage.getItem(POS_KEY) || '0');
                if (isFinite(pos) && pos > 0 && (!isFinite(audio.duration) || pos < audio.duration - 0.4)) { audio.currentTime = pos; }
            });
            const savePos = () => { if (isFinite(audio.currentTime)) localStorage.setItem(POS_KEY, String(audio.currentTime)); };
            setInterval(savePos, 1000); window.addEventListener('pagehide', savePos);
            btn.addEventListener('click', async () => { if (audio.paused) { localStorage.setItem(STATE_KEY, 'on'); await tryPlay(); } else { audio.pause(); setBtn(false); localStorage.setItem(STATE_KEY, 'off'); } });
            if ((localStorage.getItem(STATE_KEY) ?? 'on') === 'on') tryPlay(); else setBtn(false);
            document.addEventListener('visibilitychange', () => { if (!document.hidden && localStorage.getItem(STATE_KEY) === 'on' && audio.paused) tryPlay(); });
        })();

        /* 첫 진입 fresh */
        (function () {
            function z(n) { return String(n).padStart(2, '0') }
            function fmt(d) { return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}` }
            const u = new URL(location.href);
            if (!u.searchParams.has('fresh')) {
                if (!u.searchParams.get('date')) u.searchParams.set('date', fmt(new Date()));
                u.searchParams.set('fresh', '1'); return location.replace(u.toString());
            }
        })();

        /* 우측 상단 시각 텍스트(요소 없으면 스킵) */
        (function () {
            const el = document.getElementById('nowTime'); if (!el) return;
            function tick() { const now = new Date(); el.textContent = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }); }
            tick(); setInterval(tick, 30 * 1000);
        })();
    </script>
    <script>
        // ... setFlowerImage(slug) 함수 바로 아래에 추가하세요.
        function refreshPreview() {
            // 감정 키워드가 선택되면 내가 만든 flowers2 이미지를 중앙 크게 노출
            if (state.keyword) {
                setFlowerImage(state.keyword.slug);
                flowerImg.classList.add('big');
                flowerImg.alt = state.keyword.flower || state.keyword.slug;
            } else {
                // 선택 해제 시 숨김
                flowerImg.classList.remove('big');
                flowerImg.removeAttribute('src');
            }

            // 진행 표시만 업데이트(오른쪽 스텝 꽃 아이콘 등)
            updateProgressUI();
        }
    </script>

    <script>
        const KEYWORDS = [{ label: '기쁨', flower: '수국', slug: 'hydrangea' }, { label: '설렘', flower: '안개꽃', slug: 'babybreath' }, { label: '평온', flower: '라벤더', slug: 'lavender' }, { label: '슬픔', flower: '프리지아', slug: 'freesia' }, { label: '외로움', flower: '데이지', slug: 'daisy' }, { label: '화남', flower: '흰 백합', slug: 'white-lily' }, { label: '지침', flower: '라일락', slug: 'lilac' }, { label: '불안', flower: '흰 튤립', slug: 'white-tulip' }, { label: '감사', flower: '해바라기', slug: 'sunflower' }, { label: '후회', flower: '작약', slug: 'peony' }, { label: '상실감', flower: '물망초', slug: 'forgetmenot' }, { label: '혼란', flower: '연꽃', slug: 'lotus' }];
        const EN_NAME = { 'hydrangea': 'HYDRANGEA', 'babybreath': "BABY'S BREATH", 'lavender': 'LAVENDER', 'freesia': 'FREESIA', 'daisy': 'DAISY', 'white-lily': 'WHITE LILY', 'lilac': 'LILAC', 'white-tulip': 'WHITE TULIP', 'sunflower': 'SUNFLOWER', 'peony': 'PEONY', 'forgetmenot': 'FORGET-ME-NOT', 'lotus': 'LOTUS' };
        const PROPS = [{ label: '별', slug: 'star', img: 'img/sp/star.svg' }, { label: '바람', slug: 'wind', img: 'img/sp/wind.svg' }, { label: '나비', slug: 'butterfly', img: 'img/sp/butterfly.svg' }, { label: '비', slug: 'rain', img: 'img/sp/rain.svg' }, { label: '구름', slug: 'cloud', img: 'img/sp/cloud.svg' }, { label: '울타리', slug: 'fence', img: 'img/sp/fence.svg' }, { label: '잔디', slug: 'grass', img: 'img/sp/grass.svg' }];

        const FLOWER_DESC = {
            'hydrangea': '작은 꽃송이들이 모여 둥글게 피는 수국은 ‘감사’와 ‘진심’을 상징해요. 기쁨이 쌓여 더 큰 행복이 되고, 주변과 나누며 깊어지는 감정을 표현합니다.',
            'babybreath': '가는 줄기 위에 촘촘히 피어난 안개꽃은 ‘순수한 사랑’과 ‘변치 않는 마음’을 상징해요. 설렘의 순간이 잔잔한 기대감으로 이어지도록 도와줍니다.',
            'lavender': '라벤더는 은은한 향기와 보랏빛으로 ‘평온’과 ‘정서적 안정’을 의미해요. 마음의 긴장을 풀어주고 차분한 상태를 유지하게 해줍니다.',
            'freesia': '부드럽고 따뜻한 색감의 프리지아는 ‘위로’와 ‘새 출발’을 상징해요. 상실감과 슬픔 속에서도 다시 걸어 나갈 수 있는 희망을 전해줍니다.',
            'daisy': '데이지는 단순하고 밝은 형태로 ‘순수한 우정’과 ‘희망’을 뜻해요. 외로운 마음을 포근하게 감싸주며, 사람과 다시 연결될 수 있는 가능성을 느끼게 해줍니다.',
            'white-lily': '흰 백합은 ‘순수함’과 ‘정화’를 상징해요. 격해진 감정을 조용히 가라앉히고, 내면의 균형을 되찾을 수 있도록 도와줍니다.',
            'lilac': '라일락은 ‘휴식’과 ‘영혼의 안정’을 의미하며, 향기와 색이 지친 몸과 마음을 편안하게 감싸줍니다. 회복과 쉼을 상징하는 꽃이에요.',
            'white-tulip': '하얀 튤립은 ‘용기’, ‘새로운 시작’을 상징해요. 불안한 감정 속에서도 부드럽게 위로해주며, 앞으로 나아갈 수 있는 힘을 북돋아줍니다.',
            'sunflower': '태양을 향해 피어나는 해바라기는 ‘긍정’, ‘존경’, ‘감사’를 의미해요. 밝고 활기찬 감정에 에너지를 더하고, 감사한 마음을 전하는 데 적합합니다.',
            'peony': '풍성하고 화려한 작약은 ‘행복한 삶’과 ‘깊은 애정’을 상징해요. 과거의 후회를 따뜻하게 감싸며, 스스로를 받아들이고 성장할 수 있는 용기를 줍니다.',
            'forgetmenot': '작고 파란 물망초는 ‘진실한 사랑’과 ‘기억’을 뜻해요. 떠난 것에 대한 아픔을 인정하고, 소중한 기억으로 간직할 수 있게 도와줍니다.',
            'lotus': '진흙 속에서도 맑고 깨끗하게 피는 연꽃은 ‘청정’, ‘극복’, ‘내면의 평화’를 상징해요. 복잡하고 흔들리는 마음을 정리하고 중심을 잡게 해줍니다.'
        };

        // 선택한 감정의 커스텀 카드 이미지를 적용 (없으면 기본 폴더로 폴백)
        function setFlowerImage(slug) {
            const custom = `img/flowers2/${slug}2.svg`;      // 네가 만든 파일 규칙
            const fallback = `img/flowers/${slug}.svg`;      // 기존 기본 카드

            // 에러 발생 시 한 번만 폴백
            flowerImg.onerror = null;
            flowerImg.src = custom;
            flowerImg.onerror = () => {
                flowerImg.onerror = null;
                flowerImg.src = fallback;
            };
        }

        const state = { mood: '', keyword: null, weather: null };
        const moodInput = document.getElementById('moodInput');
        const cardTitle = document.getElementById('cardTitle'), cardSub = document.getElementById('cardSub'), cardQuote = document.getElementById('cardQuote');
        const keywordGrid = document.getElementById('keywordGrid'), propGrid = document.getElementById('propGrid');
        const flowerImg = document.getElementById('flowerImg'), prop0 = document.getElementById('prop0'), prop1 = document.getElementById('prop1');
        const descBox = document.getElementById('flowerDescLeft'), descText = document.getElementById('flowerDescLeftText');

        function imgPath(type, slug) {
            if (type === 'weather') return `img/weather/${slug}.svg`;
            if (type === 'flower') return `img/flowers/${slug}.svg`;
            if (type === 'prop') { const p = PROPS.find(p => p.slug === slug); return p?.img || `img/props/${slug}.svg`; }
            return '';
        }
        function updateTexts() {
            if (state.keyword) {
                cardTitle.textContent = EN_NAME[state.keyword.slug] || state.keyword.slug.toUpperCase();
                cardSub.textContent = `${state.keyword.flower} · ${state.keyword.label}`;
            } else { cardTitle.textContent = ''; cardSub.textContent = ''; }
            cardQuote.textContent = state.mood || '오늘의 한 줄 기분을 적어주세요.';
        }
        function renderDescription() {
            const slug = state?.keyword?.slug;
            if (slug && FLOWER_DESC[slug]) { descText.textContent = FLOWER_DESC[slug]; descBox.hidden = false; }
            else { descBox.hidden = true; }
        }


        const WEATHERS = [{ label: '햇빛', slug: 'sun' }, { label: '비', slug: 'rain' }, { label: '번개', slug: 'lightning' }, { label: '눈', slug: 'snow' }];

        function renderKeywords() {
            keywordGrid.innerHTML = '';
            KEYWORDS.forEach(k => {
                const div = document.createElement('div'); div.className = 'chip'; div.textContent = k.label;
                div.addEventListener('click', () => {
                    if (state.keyword && state.keyword.slug === k.slug) { state.keyword = null;[...keywordGrid.children].forEach(el => el.classList.remove('active')); }
                    else { state.keyword = k;[...keywordGrid.children].forEach(el => el.classList.remove('active')); div.classList.add('active'); }
                    refreshPreview();
                });
                keywordGrid.appendChild(div);
            });
        }
        function renderWeather() {
            propGrid.innerHTML = '';
            WEATHERS.forEach(w => {
                const div = document.createElement('div'); div.className = 'chip'; div.textContent = w.label;
                if (state.weather && state.weather.slug === w.slug) div.classList.add('active');
                div.addEventListener('click', () => {
                    if (state.weather && state.weather.slug === w.slug) { state.weather = null;[...propGrid.children].forEach(el => el.classList.remove('active')); }
                    else { state.weather = w;[...propGrid.children].forEach(el => el.classList.remove('active')); div.classList.add('active'); }
                    refreshPreview(); updateProgressUI();
                });
                propGrid.appendChild(div);
            });
        }

        const flowers = [...document.getElementById('progressFlowers').querySelectorAll('.f')];
        function updateProgressUI() {
            const done1 = !!state.mood, done2 = !!state.keyword, done3 = !!state.weather, done4 = done1 && done2 && done3;
            flowers.forEach(el => el.classList.remove('todo', 'active', 'done'));
            if (flowers[0]) flowers[0].classList.add(done1 ? 'done' : 'active');
            if (flowers[1]) flowers[1].classList.add(done2 ? (done1 ? 'done' : 'todo') : (done1 ? 'active' : 'todo'));
            if (flowers[2]) flowers[2].classList.add(done3 ? (done1 && done2 ? 'done' : 'todo') : (done1 && done2 ? 'active' : 'todo'));
            if (flowers[3]) flowers[3].classList.add(done4 ? 'done' : 'todo');
        }
        moodInput.addEventListener('input', e => { state.mood = e.target.value.trim(); refreshPreview(); });

        function z(n) { return String(n).padStart(2, '0') }
        function fmt(d) { return [d.getFullYear(), z(d.getMonth() + 1), z(d.getDate())].join('-') }
        const url = new URL(location.href);
        const dateParam = url.searchParams.get('date') || fmt(new Date());
        const freshParam = url.searchParams.get('fresh') === '1';

        function readTodayStore() {
            try {
                const raw = localStorage.getItem('moodiary_today'); if (!raw) return {}; const v = JSON.parse(raw);
                if (Array.isArray(v)) { const o = {}; v.forEach(it => { if (it?.date) o[it.date] = it; }); return o; } return v && typeof v === 'object' ? v : {};
            } catch (e) { return {}; }
        }
        function writeTodayStore(obj) { localStorage.setItem('moodiary_today', JSON.stringify(obj)); }
        window.moodiaryGetToday = (d) => readTodayStore()[d] || null;

        document.getElementById('saveToday').addEventListener('click', () => {
            const store = JSON.parse(localStorage.getItem('moodiary_today') || '{}');
            const date = new URL(location.href).searchParams.get('date');

            store[date] = {
                date,
                oneLine: state.mood,
                feeling: state.keyword?.label,
                flowers: state.keyword
                    ? [{ slug: state.keyword.slug, name: state.keyword.flower, img: `img/flowers2/${state.keyword.slug}2.svg` }]
                    : [],
                weather: state.weather ? state.weather.slug : null,
                desc: state.keyword ? FLOWER_DESC[state.keyword.slug] : null
            };

            localStorage.setItem('moodiary_today', JSON.stringify(store));

            // ✅ day.html로 이동하면서 snap-day 해시 붙여 전달
            location.href = `diary-loding.html?date=${encodeURIComponent(date)}#snap-day`;
        });


        document.getElementById('goDiaryBtn').addEventListener('click', () => {
            stampCardTime(dateParam);

            // 1단계: diary-loding.html로 이동
            window.location.href = "diary-loding.html?next=day";
        });

        (function preloadIfExists() {
            if (freshParam) return;
            const saved = window.moodiaryGetToday(dateParam); if (!saved) return;
            state.mood = saved.feeling || ''; document.getElementById('moodInput').value = state.mood;
            if (saved.keywords && saved.keywords[0]) { const k = KEYWORDS.find(k => k.label === saved.keywords[0]); state.keyword = k || null; }
            if (saved.weather) { const w = WEATHERS.find(x => x.slug === saved.weather); state.weather = w || null; }
            refreshPreview();
        })();

        renderKeywords(); renderWeather(); refreshPreview(); updateProgressUI();

        /* ✿ custom cursor */
        (function () {
            const c = document.createElement('div'); c.className = 'flower-cursor'; c.textContent = '✿'; document.body.appendChild(c);
            let x = 0, y = 0, tx = 0, ty = 0;
            document.addEventListener('mousemove', e => { x = e.clientX; y = e.clientY; });
            document.addEventListener('mouseover', e => { if (e.target.closest('a,button')) c.classList.add('active'); else c.classList.remove('active'); });
            (function loop() { tx += (x - tx) * 0.25; ty += (y - ty) * 0.25; c.style.transform = `translate(${tx}px,${ty}px) translate(-50%,-50%)`; requestAnimationFrame(loop); })();
        })();

        // index.html에서 전달된 text 값을 입력창에 반영
        (function () {
            const u = new URL(location.href);
            const text = u.searchParams.get('text');
            if (text) { const moodInput = document.getElementById('moodInput'); if (moodInput) { moodInput.value = text; } }
        })();
    </script>

    <script>
        // (선택) 오늘 날짜 텍스트 — 요소 없으면 스킵
        (function () {
            const el = document.getElementById("todayDate"); if (!el) return;
            const now = new Date(); const z = n => String(n).padStart(2, '0'); const week = ["일", "월", "화", "수", "목", "금", "토"];
            el.textContent = `📅 ${now.getFullYear()}-${z(now.getMonth() + 1)}-${z(now.getDate())} (${week[now.getDay()]})`;
        })();
    </script>
    <script>
        (function addButterflies() {
            const container = document.getElementById("backgroundDecor");
            const butterflyImgs = ["img/sp/butterfly1.svg", "img/sp/butterfly2.svg", "img/sp/butterfly3.svg", "img/sp/butterfly4.svg"];
            for (let i = 0; i < 6; i++) {
                const img = document.createElement("img");
                img.src = butterflyImgs[Math.floor(Math.random() * butterflyImgs.length)];
                img.className = "butterfly";
                img.style.top = Math.random() * 90 + "%";
                img.style.left = Math.random() * 90 + "%";
                img.style.width = (60 + Math.random() * 40) + "px";
                img.style.animationDuration = (5 + Math.random() * 4) + "s";
                container.appendChild(img);
            }
        })();
    </script>
</body>

</html>
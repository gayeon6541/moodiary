<!DOCTYPE html>
<html lang="ko">

<head>
    <!-- === í™˜ê²½ ë³´ì¥ (html2canvas + IDB) === -->
    <script>
        (function ensureEnv() {
            if (!window.html2canvas) {
                const s = document.createElement('script');
                s.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
                document.head.appendChild(s);
            }
            if (!window.IDB || !window.IDB.put) {
                function idbStore() {
                    const DB = 'moodiary-db', ST = 'garden'; let dbp = null;
                    const open = () => dbp || (dbp = new Promise((res, rej) => {
                        const r = indexedDB.open(DB, 1);
                        r.onupgradeneeded = () => r.result.createObjectStore(ST);
                        r.onsuccess = () => res(r.result);
                        r.onerror = () => rej(r.error);
                    }));
                    const put = (k, blob) => open().then(db => new Promise((res, rej) => {
                        const tx = db.transaction(ST, 'readwrite'); const st = tx.objectStore(ST);
                        const rq = st.put(blob, k); rq.onsuccess = () => res(true); rq.onerror = () => rej(rq.error);
                    }));
                    return { put };
                }
                window.IDB = idbStore();
            }
        })();
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MOODIARY â€“ Day Detail</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pretendard@1.3.9/dist/web/static/pretendard.css"
        crossorigin>

    <style>
        :root {
            --ink: #111;
            --muted: #666;
            --bg: #ffffff;
            --header-h: 72px;
            --side: clamp(14px, 3vw, 36px);
            --line: #111;
            --gap: 18px;
            --border: 0.5px;
            --cell: 26px;
            --dcal-gap: 4px;
            --dcal-border: 1px;
            --orange: #9ac4e4;
            --gray: #8E8E8E;
            --side: clamp(16px, 4vw, 60px);
        }

        * {
            box-sizing: border-box
        }

        html {
            scroll-behavior: smooth
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: Pretendard, system-ui, -apple-system, BlinkMacSystemFont, Inter, sans-serif;
            line-height: 1.55;
            cursor: none
        }

        /* ===== í—¤ë” ===== */
        /* day.html */
        header.site {
            position: sticky;
            top: 0;
            z-index: 50;
            height: var(--header-h);
            background: rgba(255, 255, 255, .9);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid #eaeaea;
            /* âœ… ì¶”ê°€ */
        }

        .wrap {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 var(--side);
        }

        .bar {
            height: var(--header-h);
            display: grid;
            gap: 10px;
            grid-template-columns: 140px 1fr auto auto;
            align-items: center
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: inherit
        }

        .brand img {
            width: 40px;
            height: 40px;
            display: block;
            animation: float 2.4s ease-in-out infinite
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-5px)
            }
        }

        /* day.html */
        nav.main {
            display: flex;
            justify-content: flex-end;
            gap: 22px;
            /* âœ… todayì™€ ë™ì¼ */
        }


        nav.main a {
            position: relative;
            text-decoration: none;
            color: var(--ink);
            padding: 4px 2px;
            font-weight: 500
        }

        nav.main a::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: -6px;
            height: 2px;
            background: currentColor;
            transform: scaleX(0);
            transform-origin: 0 50%;
            transition: transform .25s
        }

        nav.main a:hover::after {
            transform: scaleX(1)
        }

        .sound {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--muted);
            margin-left: clamp(8px, 1vw, 14px)
        }

        .sound button {
            border: 1.25px solid #000;
            border-radius: 0;
            background: #fff;
            padding: 8px 12px;
            cursor: pointer;
            transition: background .25s, color .25s
        }

        .sound button:hover {
            background: #000;
            color: #fff
        }

        /* ===== ë©”ì¸ ê·¸ë¦¬ë“œ ===== */
        main {
            padding: 30px var(--side) 14px;
            min-height: calc(100vh - var(--header-h) - 16px)
        }

        .grid3 {
            display: grid;
            gap: var(--gap);
            /* ì™¼ìª½ í­ ì¤„ì´ê³  ì˜¤ë¥¸ìª½ì„ ë” í¬ê²Œ */
            grid-template-columns: minmax(360px, 0.9fr) minmax(600px, 1.4fr);
            align-items: stretch;
        }



        @media (max-width:1200px) {
            .grid3 {
                grid-template-columns: 1fr
            }
        }

        /* ì™¼ìª½: 1:1 ë ˆì´ì•„ì›ƒ (ë‹¬ë ¥ / ì¹´ë“œ+ì„¤ëª…) */
        .left-half {
            display: grid;
            gap: var(--gap);
            grid-template-columns: 1fr 1fr;
            /* 1 : 1 */
            grid-template-rows: 1fr;
            /* í•œ ì¤„ */
            grid-template-areas: "cal desc";
            align-items: stretch;
            min-height: 0;
            height: 100%;
        }

        @media (max-width:1200px) {
            .left-half {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                grid-template-areas: "cal""desc"
            }
        }

        .panel {
            border-radius: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
            border: var(--border) solid var(--line);
            box-shadow: 0 6px 14px rgba(0, 0, 0, .06)
        }

        .panel-h {
            background-color: #fff;
            border-bottom: var(--border) dashed var(--line);
            padding: 15px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .panel-b {
            background-color: #fff;
            padding: 12px;
            min-height: 0;
            flex: 1;
            overflow: auto;
        }

        .btn {
            border: var(--border) solid var(--line);
            border-radius: 0;
            background: #fff;
            padding: 8px 12px;
            cursor: pointer;
            transition: background .2s, color .2s, transform .1s
        }

        .btn:hover {
            background: #000;
            color: #fff
        }

        .btn:active {
            transform: translateY(1px)
        }

        /* ë¯¸ë‹ˆ ìº˜ë¦°ë” */
        .mini-cal {
            display: grid;
            gap: 10px;
            align-items: center
        }

        .cal-head {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            padding: 0 2px
        }

        .cal-title {
            font-weight: 700;
            font-size: 20px;
        }

        .cal-nav {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        /* ë‹¬ë ¥ ê½‰ì°¨ê²Œ ìˆ˜ì • */
        .week,
        .grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--dcal-gap);
            /* â† ì—¬ê¸°ì„œ ë°˜ì˜ë¨ */
            width: 100%;
            max-width: none;
            margin: 0 auto;
        }


        .cell {
            position: relative;
            border: 0.5px solid #111;
            background: transparent;
            aspect-ratio: 1/1;
            /* ì •ì‚¬ê°í˜• */
            width: 100%;
            /* í•œ ì¹¸ì„ ìë™ìœ¼ë¡œ ì±„ì›€ */
            cursor: pointer;
            transition: transform .12s ease, box-shadow .12s ease;
            font-size: 0;
            display: block;
            -webkit-appearance: none;
            appearance: none;
            padding: 0;
            border-radius: 0;
        }


        .cell:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, .06)
        }

        .cell.off {
            background: #f7f7f7;
            cursor: default
        }

        .cell.today {
            outline: 2px solid rgba(0, 0, 0, .15)
        }

        .cell.sel {
            outline: 2px solid #000
        }

        .week>div {
            width: var(--cell);
            height: var(--cell);
            display: grid;
            place-items: center;
            font-size: 16px;
            font-weight: 400;
            color: #999
        }

        .cell:focus-visible {
            outline: 2px solid #000;
            outline-offset: -2px
        }

        #leftInfo {
            text-align: center;
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            /* ğŸ‘ˆ ìœ„ ì—¬ë°± ì¶”ê°€ */
        }


        .mark-flower {
            position: absolute;
            right: 2px;
            bottom: 2px;
            font-size: 13px;
            line-height: 1;
            color: var(--gray)
        }

        .mark-flower.orange {
            color: var(--orange)
        }

        .mark-dot {
            display: none
        }

        /* Card Description ë‚´ë¶€ êµ¬ì„± */
        .desc-area {
            grid-area: desc
        }

        .desc-wrap {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .desc-text {
            margin: 0;
            color: #333;
            line-height: 1.7;
            font-size: 14px;
            white-space: pre-line
        }

        /* â–¶ í”Œë¼ì›Œì¹´ë“œ (Card Description ì•ˆìœ¼ë¡œ ì´ë™) */
        .card {
            width: min(420px, 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            overflow: hidden;
            border-radius: 0
        }

        .card-art {
            background-color: #fff;
            position: relative;
            flex: 1 1 auto;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center
        }

        #flowerImg {
            max-width: 90%;
            max-height: 76%;
            object-fit: contain;
            transition: transform .28s ease
        }

        /* ì¹´ë“œì—” ì†Œí’ˆ ìˆ¨ê¹€ */
        .overlay-prop {
            display: none !important
        }

        .card-title {
            margin: 0;
            font-size: clamp(18px, 4.6vw, 26px);
            font-weight: 600;
            letter-spacing: .8px;
            font-family: ui-serif, "Times New Roman", Georgia, serif
        }

        .card-quote {
            width: 100%;
            min-height: 44px;
            border: 0.5px solid #111;
            padding: 10px 12px;
            text-align: center;
            color: #2a2a2a;
            font-size: 14px;
            font-style: italic;
            letter-spacing: .1px
        }

        .card-sub {
            color: #5a5a5a;
            font-size: clamp(12px, 2.6vw, 14px);
            letter-spacing: .2px
        }

        /* ì˜¤ë¥¸ìª½ ì—ë””í„° */
        .editor-wrap {
            background-color: #fff;
            display: grid;
            gap: 10px;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto 1fr;
            height: 100%
        }

        .toolbar {
            grid-column: 1/-1;
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap
        }

        .canvas {
            border: 0.5px solid #111;
            grid-column: 1;
            grid-row: 2;
            position: relative;
            overflow: hidden;
            min-height: clamp(380px, 52vh, 560px);
            aspect-ratio: 1/1;
            background-size: cover;
            background-position: center
        }

        .options-col {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: auto;
            padding: 8px;
            max-width: 420px
        }

        .section-title {
            font-weight: 400;
            margin: 0 0 6px 0;
            font-size: 13px;
            letter-spacing: .2px
        }

        .panel-sec+.panel-sec {
            border-top: 0.5px dashed #111;
            padding-top: 8px
        }

        .assets {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        /* ë°°ê²½/ì†Œí’ˆ ì¸ë„¤ì¼ â€” 64Ã—64 ê³ ì • */
        .thumbs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
            gap: 8px
        }

        .thumb {
            width: 64px;
            height: 64px;
            /* â† í…Œë‘ë¦¬ ë°•ìŠ¤ 64Ã—64 ê³ ì • */
            border: 0.5px solid #111;
            background: #fff;
            padding: 0;
            place-items: center;
            cursor: pointer;
            aspect-ratio: 1/1
        }

        .thumb img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            display: block;
            place-items: center;

        }

        /* âœ¿ custom cursor */
        .flower-cursor {
            position: fixed;
            left: 0;
            top: 0;
            z-index: 9999;
            pointer-events: none;
            user-select: none;
            width: 40px;
            height: 40px;
            display: grid;
            place-items: center;
            font-size: 20px;
            line-height: 1;
            transform: translate(-50%, -50%);
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, .12))
        }

        .flower-cursor::before {
            content: "";
            position: absolute;
            inset: 0;
            border: 2px solid #111;
            border-radius: 999px;
            box-sizing: border-box
        }

        .flower-cursor.active {
            transform: translate(-50%, -50%) scale(1.06)
        }

        /* ì„ íƒ/í¸ì§‘ íˆ´ */
        .selbox {
            position: absolute;
            pointer-events: none;
            border: 1.0px dashed #111;
            outline: 2px solid rgba(0, 0, 0, .05);
            transform-origin: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .06)
        }

        .handle {
            position: absolute;
            width: 14px;
            height: 14px;
            border: 1px solid #111;
            background: #fff;
            pointer-events: auto
        }

        .h-nw {
            left: -7px;
            top: -7px;
            cursor: nwse-resize
        }

        .h-ne {
            right: -7px;
            top: -7px;
            cursor: nesw-resize
        }

        .h-sw {
            left: -7px;
            bottom: -7px;
            cursor: nesw-resize
        }

        .h-se {
            right: -7px;
            bottom: -7px;
            cursor: nwse-resize
        }

        .h-rot {
            left: 50%;
            transform: translateX(-50%);
            top: -26px;
            width: 16px;
            height: 16px;
            border-radius: 999px;
            cursor: grab
        }

        /* ğŸ”¸ Mini Calendar Bigger: ì…€/ê°„ê²©/í…ìŠ¤íŠ¸ í™•ëŒ€ */
        :root {
            --cell: clamp(24px, 3vw, 36px);
            --dcal-gap: 2px;
            /* ê¸°ì¡´ 4px â†’ 2px ë¡œ ì¢í˜ */
        }


        /* ìš”ì¼ ë¼ë²¨/ì•„ì´ì½˜ ê°€ë…ì„± â†‘ */
        .week {
            font-size: 12px;
        }

        .week>div {
            width: var(--cell);
            height: var(--cell);
        }

        .cell {
            width: var(--cell);
            height: var(--cell);
        }

        .mark-flower {
            font-size: 16px;
            right: 3px;
            bottom: 3px;
        }

        /* ìƒë‹¨ ì›”/ë…„ë„ íƒ€ì´í‹€ ê°•ì¡° */
        .cal-title {
            font-size: 14px;
        }

        #ytext {
            font-size: 14px;
        }

        /* ì¢ì€ í™”ë©´ì—ì„œëŠ” ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šë„ë¡ ì•ˆì „ì¥ì¹˜ */
        @media (max-width: 640px) {
            :root {
                --cell: 30px;
                --dcal-gap: 4px;
            }

            .week {
                font-size: 11px;
            }
        }

        /* === Mini Calendar 1:1(ìƒ/í•˜) ë ˆì´ì•„ì›ƒ === */
        .mini-cal {
            display: grid;
            grid-template-rows: 1fr 1fr;
            /* ìœ„/ì•„ë˜ ì •í™•íˆ ë°˜ëµ */
            gap: 10px;
            height: 100%;
            min-height: 0;
        }

        .mini-cal-top {
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            /* í—¤ë”/ìš”ì¼/ê·¸ë¦¬ë“œ/íŒíŠ¸ */
            min-height: 0;
        }

        .mini-cal-top .grid {
            /* ë‹¬ë ¥ ê·¸ë¦¬ë“œê°€ ìƒë‹¨ ì˜ì—­ì„ ê½‰ ì±„ìš°ë©°, í–‰ ë†’ì´ë¥¼ ìë™ ê· ë“± */
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            /* ì„¸ë¡œë„ ì˜ì—­ì„ ê½‰ ì±„ìš°ë„ë¡ ì •ì‚¬ê°ì— ìµœëŒ€ ê·¼ì ‘ */
            gap: var(--dcal-gap);
            width: 100%;
            min-height: 0;
        }

        .mini-cal-top .cell {
            width: 100%;
            aspect-ratio: 1/1;
            /* ì •ì‚¬ê° ìœ ì§€ */
        }

        /* === í•˜ë‹¨: ê¸°ë¡ ìš”ì•½ === */
        .mini-details {
            width: 100%;
            aspect-ratio: 1 / 1;
            /* ì •ì‚¬ê°í˜• */
            overflow: auto;
            /* ë‚´ìš© ë§ìœ¼ë©´ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
            display: block;
            /* grid/flex ê°„ì„­ ë°©ì§€ */
        }

        .md-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            align-items: start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .md-label {
            font-size: 12px;
            color: #999;
            font-weight: 700;
        }

        .md-val {
            font-size: 14px;
            line-height: 1.0;
        }

        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .chips .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px;
            background: #fff;
            font-size: 12px;
            font-weight: 500;
        }

        .chips .chip img.icon {
            width: 16px;
            height: 16px;
            object-fit: contain;
            display: block;
        }

        /* â˜ï¸ ë°°ê²½ìš© ì»¨í…Œì´ë„ˆ */
        .background-decor {
            position: fixed;
            inset: 0;
            overflow: hidden;
            z-index: -1;
            /* í™”ë©´ ì œì¼ ë’¤ì— */
        }

        /* â˜ï¸ êµ¬ë¦„ ìŠ¤íƒ€ì¼ */
        .cloud {
            position: absolute;
            opacity: 0.85;
            animation: floatCloud linear infinite;
            will-change: transform;
        }

        /* ê¸°ë³¸ ì• ë‹ˆë©”ì´ì…˜ ê²½ë¡œ */
        @keyframes floatCloud {
            0% {
                transform: translateX(-250px) translateY(0);
            }

            50% {
                transform: translateX(60vw) translateY(-15px);
            }

            100% {
                transform: translateX(120vw) translateY(0);
            }
        }

        body {
            margin: 0;
            overflow: hidden;
            /* ìŠ¤í¬ë¡¤ ì•ˆ ë³´ì´ê²Œ */
        }

        main {
            min-height: calc(100vh - var(--header-h));
            display: flex;
            align-items: center;
            /* ì„¸ë¡œ ê°€ìš´ë° */
            justify-content: center;
            /* ê°€ë¡œ ê°€ìš´ë° */
            padding: 0 var(--side);
            /* ìœ„ì•„ë˜ ì—¬ë°± ì œê±° */
        }

        .grid3 {
            max-height: calc(100vh - var(--header-h));
            width: 100%;
        }

        .panel {
            height: 100%;
        }
    </style>
    <style>
        /* === Scroll Snap ì»¨í…Œì´ë„ˆ === */
        html,
        body {
            height: 100%;
        }

        body {
            overflow: hidden;
        }

        /* ê¸°ì¡´ì— ìˆ¨ê¹€ ìœ ì§€ */

        .snap-viewport {
            height: 100vh;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
        }

        .snap-section {
            min-height: 100vh;
            scroll-snap-align: start;
            display: block;
        }

        /* ì„¸ì…˜ 1, ì„¸ì…˜ 2 ë‚´ìš© ìƒë‹¨ ì—¬ë°± ì¶”ê°€ */
        /* 1) ì„¹ì…˜ ìƒë‹¨ íŒ¨ë”© ì œê±° */
        #snap-diary,
        #snap-day {
            scroll-margin-top: var(--header-h);
            /* ìƒˆë¡œê³ ì¹¨ ë•Œ í—¤ë”ë§Œí¼ ì—¬ë°± í™•ë³´ */
        }

        /* ì„¸ì…˜1 ë‹¬ë ¥ ìœ„ìª½ ì—¬ë°±ì„ í—¤ë”ë³´ë‹¤ ì¡°ê¸ˆ ë” í™•ë³´ */
        #snap-diary {
            scroll-margin-top: calc(var(--header-h) + 20px);
            /* í—¤ë” ë†’ì´ + ì¶”ê°€ ì—¬ë°± */
        }


        /* 2) ìŠ¤ëƒ… ì»¨í…Œì´ë„ˆê°€ í—¤ë”ë§Œí¼ ìœ„ìª½ ì—¬ë°±ì„ ì¸ì§€í•˜ë„ë¡ */
        .snap-viewport {
            scroll-padding-top: var(--header-h);
            scroll-padding-top: var(--header-h);
            /* í—¤ë” ë†’ì´ë§Œí¼ ë³´ì • */
        }


        /* === diary.html ë‹¬ë ¥ ì„ë² ë“œ ì „ìš© ë„¤ì„ìŠ¤í˜ì´ìŠ¤ === */
        /* === diary.html ìŠ¤íƒ€ì¼ê³¼ ë™ì¼í•˜ê²Œ ì ìš© === */
        #diaryEmbed {
            padding: 0 var(--side);
            height: calc(100vh - var(--header-h));
            display: grid;
            align-items: stretch;
        }

        #diaryEmbed .calendar {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #diaryEmbed .cal-head {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: end;
            gap: 12px;
            padding: 10px;
        }

        #diaryEmbed .cal-hero {
            font-family: "IM Fell Double Pica SC", serif;
            font-weight: 100;
            font-size: 100px;
            line-height: 1;
            color: #111;
        }

        #diaryEmbed .cal-title {
            font-family: "IM Fell Double Pica SC", serif;
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        #diaryEmbed .cal-title .mname {
            font-weight: 500;
            font-size: 40px;
            color: #111;
        }

        #diaryEmbed .cal-title .year {
            font: 400 14px/1.2 Pretendard, system-ui, sans-serif;
            color: #999;
            font-weight: 600;
        }

        #diaryEmbed .cal-nav {
            display: flex;
            gap: 8px;
        }

        #diaryEmbed .btn {
            appearance: none;
            border: 0.5px solid var(--line, #111);
            background: #fff;
            padding: 6px 10px;
            font-weight: 500;
            cursor: pointer;
        }

        #diaryEmbed .week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 8px 8px 6px;
            color: #000;
            font-weight: 500;
            font-size: 12px;
        }

        #diaryEmbed .grid {
            flex: 1;
            min-height: 0;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 0 8px 10px;
            grid-auto-rows: 1fr;
        }

        #diaryEmbed .cell {
            position: relative;
            border: 0.5px solid var(--line, #111);
            overflow: hidden;
            cursor: pointer;
            transition: transform .15s, box-shadow .15s;
        }

        #diaryEmbed .cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(0, 0, 0, .08);
        }

        #diaryEmbed .cell.off {
            background: #fafafa;
            cursor: default;
        }

        #diaryEmbed .cell.today {
            outline: 2px solid rgba(0, 0, 0, .15);
        }

        #diaryEmbed .cell.sel {
            outline: 2px solid #000;
        }

        #diaryEmbed .date-number {
            position: absolute;
            top: 6px;
            left: 6px;
            font-weight: 400;
            font-size: 18px;
            color: #222;
            background: transparent;
            border: none;
            padding: 0;
        }

        #diaryEmbed .thumb-box {
            position: absolute;
            right: 6px;
            bottom: 6px;
            width: 40px;
            height: 40px;
            border: 0.5px solid #111;
            display: grid;
            place-items: center;
            overflow: hidden;
        }

        #diaryEmbed .cal-foot {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 10px;
            color: #777;
            font-size: 12px;
        }


        /* === ì„¸ì…˜1 ë‹¬ë ¥ ê½‰ì°¨ê²Œ (snap-diary ì „ìš©) === */
        #snap-diary #diaryEmbed .calendar {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #snap-diary #diaryEmbed .grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: 1fr;
            /* ì„¸ë¡œ ê· ë“± ë¶„ë°° */
            gap: 10px;
            /* ì…€ ì‚¬ì´ ì—¬ë°± ì¤„ì„ */
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #snap-diary #diaryEmbed .cell {
            width: 100%;
            height: 100%;
            aspect-ratio: auto;
            /* ì •ì‚¬ê°í˜• ê°•ì œ í•´ì œ */
            border: 0.5px solid #111;
        }

        /* ì„¸ì…˜1 ë‹¬ë ¥ ìˆ«ì(span) ìœ„ì—ì„œ í´ë¦­í•´ë„ ë’¤ì˜ .cellì´ í´ë¦­ë˜ê²Œ */
        #diaryEmbed .date-number {
            pointer-events: none;
        }

        .scroll-hint {
            text-align: center;
            font-size: 14px;
            color: #2878b4;
            margin-top: 12px;
            animation: blinkText 1.5s infinite;
        }

        .scroll-hint .arrow {
            display: inline-block;
            margin-left: 6px;
            animation: bounceArrow 1s infinite;
        }

        /* í…ìŠ¤íŠ¸ ë°˜ì§ */
        @keyframes blinkText {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        /* í™”ì‚´í‘œ ìœ„ì•„ë˜ ë°˜ì§ */
        @keyframes bounceArrow {

            0%,
            100% {
                transform: translateY(0);
                opacity: 1;
            }

            50% {
                transform: translateY(4px);
                opacity: 0.5;
            }
        }

        /* ê½ƒÂ·ë‚ ì”¨ 2ì¹¸ ê°€ë¡œ ë°°ì¹˜ */
        .fw-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* ê° ì»¬ëŸ¼ íƒ€ì´í‹€ */
        .fw-col-title {
            font-weight: 400;
            margin: 0 0 6px 0;
            font-size: 13px;
            letter-spacing: .2px
        }

        .thumb.blank {
            border: none;
            background: transparent;
            width: auto;
            height: auto;
            min-width: 64px;
            min-height: 64px;
        }

        /* ë°°ê²½, ê½ƒ, ë‚ ì”¨, ì†Œí’ˆ ì¸ë„¤ì¼ ëª¨ë‘ í…Œë‘ë¦¬ ì œê±° */
        #assetsBg .thumb,
        #assetsFlowerCol .thumb,
        #assetsWeatherCol .thumb,
        #assetsProps .thumb {
            border: none !important;
        }

        /* ë°°ê²½, ê½ƒ, ë‚ ì”¨, ì†Œí’ˆ ì¸ë„¤ì¼ í˜¸ë²„ ì‹œ ì‚´ì§ í™•ëŒ€ */
        #assetsBg .thumb img,
        #assetsFlowerCol .thumb img,
        #assetsWeatherCol .thumb img,
        #assetsProps .thumb img {
            transition: transform 0.25s ease;
            /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ */
        }

        #assetsBg .thumb:hover img,
        #assetsFlowerCol .thumb:hover img,
        #assetsWeatherCol .thumb:hover img,
        #assetsProps .thumb:hover img {
            transform: scale(1.3);
            /* 10% í™•ëŒ€ */
        }

        /* ìº¡ì²˜ ìˆœê°„ì—” í…Œë‘ë¦¬/ì„ íƒë°•ìŠ¤ ìˆ¨ê¹€ */
        #canvas[data-capturing="1"] {
            border-color: transparent !important;
        }

        #canvas[data-capturing="1"] .selbox,
        #canvas[data-capturing="1"] .handle {
            display: none !important;
        }

        /* ì„ íƒë°•ìŠ¤ ìš°ìƒë‹¨ X ë²„íŠ¼ */
        .handle.h-close {
            right: -26px;
            top: -26px;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            cursor: pointer;
            display: grid;
            place-items: center;
            font-size: 14px;
            line-height: 1;
            background: #fff;
            border: 1px solid #111;
            user-select: none;
        }

        .handle.h-close:hover {
            background: #000;
            color: #fff;
        }

        /* ==== Memo Area ==== */
        .memo-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-top: 0.5px dashed var(--line);
            padding-top: 10px;
        }

        .memo-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .memo-title {
            font-weight: 600;
            font-size: 14px;
            letter-spacing: .2px
        }

        .memo-date {
            color: #888;
            font-size: 12px
        }

        .memo-input {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            padding: 10px 12px;
            border: 0.5px solid var(--line);
            outline: none;
            font: 14px/1.6 Pretendard, system-ui, -apple-system, sans-serif;
            background: #fff;
        }

        .memo-input:focus {
            box-shadow: 0 0 0 2px rgba(0, 0, 0, .08)
        }

        .memo-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end
        }

        .memo-toast {
            font-size: 12px;
            color: #2878b4;
        }
    </style>

</head>

<body>
    <!-- í—¤ë” -->
    <header class="site">
        <div class="wrap">
            <div class="bar">
                <a class="brand" href="index.html"><img src="img/sub-flower.svg" alt=""><span>MOODIARY</span></a>
                <div></div>
                <!-- day.html - header ë‚´ nav.main -->
                <nav class="main">
                    <a href="today-loding.html">Today</a>
                    <a href="diary-loding.html" class="active">Diary</a>
                    <a href="flower-loding.html">Flower</a>
                </nav>

                <div class="sound">
                    <button id="soundToggle" aria-pressed="false">ğŸ”Š Sound (On)</button>
                    <audio id="bgm" preload="auto" autoplay loop playsinline src="audio/temp.m4a"></audio>
                </div>
            </div>
        </div>
    </header>

    <!-- âœ¿ custom cursor -->
    <div id="cursor" class="flower-cursor" aria-hidden="true">âœ¿</div>
    <!-- ğŸ‘‡ ìŠ¤ëƒ… ì»¨í…Œì´ë„ˆ ì‹œì‘ -->
    <div class="snap-viewport">

        <!-- ì„¹ì…˜ 1: diary ë‹¬ë ¥ -->
        <section id="snap-diary" class="snap-section">
            <div id="diaryEmbed">
                <section class="calendar" aria-label="ë‹¬ë ¥ ì˜ì—­">
                    <div class="cal-head">
                        <div class="cal-hero" id="de_monthNum">08</div>
                        <div class="cal-title">
                            <span class="mname" id="de_monthName">August</span>
                            <span class="year" id="de_yearText">2025</span>
                        </div>
                        <div class="cal-nav">
                            <button class="btn" id="de_prev" aria-label="ì´ì „ ë‹¬">&larr;</button>
                            <button class="btn" id="de_todayBtn">ì˜¤ëŠ˜</button>
                            <button class="btn" id="de_next" aria-label="ë‹¤ìŒ ë‹¬">&rarr;</button>
                        </div>
                    </div>
                    <div class="week">
                        <div>SUN</div>
                        <div>MON</div>
                        <div>TUE</div>
                        <div>WED</div>
                        <div>THU</div>
                        <div>FRI</div>
                        <div>SAT</div>
                    </div>
                    <div id="de_grid" class="grid" role="grid" aria-label="ë‹¬ë ¥ ë‚ ì§œ ê·¸ë¦¬ë“œ"></div>
                    <div class="cal-foot">
                        <div>âœ¿ ì •ì› ì‚¬ì§„ ìˆìŒ</div>
                        <!-- ì„¸ì…˜ 1 í•˜ë‹¨ ì•ˆë‚´ -->
                        <div class="scroll-hint">
                            ë‚ ì§œë¥¼ í´ë¦­í•˜ê±°ë‚˜, ìŠ¤í¬ë¡¤ì„ ë‚´ë ¤ì£¼ì„¸ìš”.
                            <span class="arrow">â¬‡</span>
                        </div>
                    </div>

                </section>
            </div>


        </section>

        <!-- ì„¹ì…˜ 2: ê¸°ì¡´ day.html ë©”ì¸ -->
        <section id="snap-day" class="snap-section">
            <!-- â†“â†“â†“ ì•„ë˜ì— 'ê¸°ì¡´ <main> ... </main>' ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ì˜®ê²¨ ë„£ê¸° â†“â†“â†“ -->
            <main>
                <div class="grid3">
                    <!-- ì™¼ìª½ 1:1 -->
                    <div class="left-half">
                        <!-- (1) ë‹¬ë ¥ -->
                        <aside class="panel cal-area" style="grid-area:cal">
                            <div class="panel-h">
                                <span id="dateBadge" style="color:rgb(0, 0, 0);font-weight:500"></span>
                                <div class="cal-nav">
                                    <button class="btn" id="prevM">âŸµ</button>
                                    <button class="btn" id="todayM">ì˜¤ëŠ˜</button>
                                    <button class="btn" id="nextM">âŸ¶</button>
                                </div>
                            </div>
                            <div class="panel-b mini-cal">
                                <!-- â¬†ï¸ ìƒë‹¨: ë‹¬ë ¥ ì „ì²´ë¥¼ í•˜ë‚˜ë¡œ ê°ì‹¸ì„œ 1fr ì˜ì—­ì— ê½‰ì°¨ê²Œ -->
                                <div class="mini-cal-top">
                                    <div class="cal-head">
                                        <div class="cal-title"><span id="mname">â€”</span> <span id="ytext"
                                                style="color:#888;font-weight:800">â€”</span></div>
                                        <button class="btn" id="goDiaryBtn">ë‹¤ì´ì–´ë¦¬ë¡œ ì´ë™í•˜ê¸°</button>

                                    </div>
                                    <div class="week">
                                        <div>S</div>
                                        <div>M</div>
                                        <div>T</div>
                                        <div>W</div>
                                        <div>T</div>
                                        <div>F</div>
                                        <div>S</div>
                                    </div>
                                    <div id="calGrid" class="grid"></div>
                                    <div id="leftInfo" class="empty-tip"></div>
                                </div>
                                <!-- âœ… ë‚ ì§œë³„ ë©”ëª¨ -->
                                <div class="memo-area" aria-label="ë©”ëª¨ ì˜ì—­">
                                    <div class="memo-head">
                                        <span class="memo-title">ë©”ëª¨</span>

                                    </div>
                                    <textarea id="memoInput" class="memo-input" placeholder="ì˜¤ëŠ˜ì˜ ë©”ëª¨ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
                                    <div class="memo-actions">
                                        <button class="btn" id="memoSaveBtn">ì €ì¥</button>
                                        <button class="btn" id="memoClearBtn">ì‚­ì œ</button>
                                    </div>
                                    <div id="memoSavedToast" class="memo-toast" role="status" aria-live="polite" hidden>
                                        ì €ì¥ëì–´ìš” âœ“</div>
                                </div>

                            </div>
                        </aside>

                        <!-- (2) Card Description + Flower Card -->
                        <section class="panel desc-area">
                            <div class="panel-h">
                                <span>Flower Card</span>
                                <button class="btn" id="editTodayBtn">ì˜¤ëŠ˜ê¸°ë¡ ìˆ˜ì •í•˜ê¸°</button>
                            </div>
                            <div class="panel-b">
                                <div class="desc-wrap">
                                    <!-- ê½ƒì¹´ë“œ(ì´ë™ë¨) -->
                                    <div class="card" id="card">
                                        <div class="card-art" id="cardArt">
                                            <img id="flowerImg" alt="">
                                            <img class="overlay-prop prop-0" id="prop0" style="display:none" alt="">
                                            <img class="overlay-prop prop-1" id="prop1" style="display:none" alt="">
                                        </div>
                                        <h3 class="card-title" id="cardTitle"></h3>
                                        <div class="card-quote" id="cardQuote">ì˜¤ëŠ˜ì˜ í•œ ì¤„ ê¸°ë¶„ì„ ì ì–´ì£¼ì„¸ìš”.</div>
                                        <div class="card-sub" id="cardSub"></div>
                                    </div>
                                    <!-- ì„¤ëª… í…ìŠ¤íŠ¸ -->
                                    <p class="desc-text" id="descPanelText">ì˜¤ëŠ˜ì˜ ê½ƒì„ ì„ íƒí•˜ë©´ ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                        </section>

                        <!-- â€» â€œì˜¤ëŠ˜ì˜ ê¸°ë¡â€ íŒ¨ë„ì€ ìš”ì²­ëŒ€ë¡œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤ -->
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: Garden Editor (ê·¸ëŒ€ë¡œ) -->
                    <section class="panel editor-area">
                        <div class="panel-h">
                            <span>ë°°ê²½, ê½ƒ, ì†Œí’ˆì„ í´ë¦­í•´ ë‚˜ë§Œì˜ ê°ì • ê³µê°„ì„ ê¾¸ë©°ë³´ì„¸ìš”.</span>
                            <div class="toolbar">
                                <div style="display:flex;gap:8px">
                                    <button class="btn" id="btnClear">ë¹„ìš°ê¸°</button>
                                    <button class="btn" id="btnDeselect">ì„ íƒ í•´ì œ</button>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn" id="btnCapture">ìº¡ì²˜ ì €ì¥</button>
                                </div>
                            </div>
                        </div>
                        <div class="panel-b">
                            <div class="editor-wrap">
                                <div class="canvas" id="canvas" aria-label="ì •ì› í¸ì§‘ ìº”ë²„ìŠ¤"></div>

                                <div class="options-col" id="optionsCol">
                                    <div id="secBg" class="panel-sec">
                                        <h4 class="section-title">ë°°ê²½</h4>
                                        <div class="thumbs" id="assetsBg"></div>
                                    </div>
                                    <div id="secFlowerWeather" class="panel-sec">
                                        <div class="fw-row">
                                            <!-- ì™¼ìª½: ê½ƒ -->
                                            <div class="fw-col">
                                                <div class="fw-col-title">ê½ƒ</div>
                                                <div class="thumbs" id="assetsFlowerCol"></div>
                                            </div>
                                            <!-- ì˜¤ë¥¸ìª½: ë‚ ì”¨ -->
                                            <div class="fw-col">
                                                <div class="fw-col-title">ë‚ ì”¨</div>
                                                <div class="thumbs" id="assetsWeatherCol"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="secProps" class="panel-sec">
                                        <h4 class="section-title">ì†Œí’ˆ</h4>
                                        <div class="assets" id="assetsProps"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </section>
    </div>
    <div class="background-decor" id="backgroundDecor"></div>

    <script>
        /* MOODIARY â€” Global BGM (m4a, ì´ì–´ë“£ê¸°/ìŒì†Œê±° ìƒíƒœ ìœ ì§€) */
        (function () {
            const audio = document.getElementById('bgm');
            const btn = document.getElementById('soundToggle');

            if (!audio || !btn) return;

            // âœ… ëª¨ë“  í˜ì´ì§€ì—ì„œ ê°™ì€ í‚¤ë¥¼ ì”ë‹ˆë‹¤ (ì´ë¯¸ ì“°ë˜ í‚¤ì™€ í˜¸í™˜)
            const STATE_KEY = 'moodiary_bgm_state'; // 'on' | 'off'
            const POS_KEY = 'moodiary_bgm_pos';   // ì¬ìƒ ìœ„ì¹˜(ì´ˆ)
            const VOL_KEY = 'moodiary_bgm_vol';   // 0.0 ~ 1.0

            // âœ… íŒŒì¼ ê°•ì œ í†µì¼
            const DESIRED_SRC = 'audio/temp.m4a';
            if (audio.getAttribute('src') !== DESIRED_SRC) audio.setAttribute('src', DESIRED_SRC);

            // ë²„íŠ¼ ë¼ë²¨ ë™ê¸°í™”
            function setBtn(on) {
                btn.textContent = on ? 'ğŸ”Š Sound (On)' : 'ğŸ”ˆ Sound (Off)';
                btn.setAttribute('aria-pressed', on ? 'true' : 'false');
            }

            // ë¶€ë“œëŸ¬ìš´ ë³¼ë¥¨ í˜ì´ë“œ
            const fps = 60;
            function fadeTo(target = 0.35, ms = 800) {
                target = Math.max(0, Math.min(1, target));
                const step = (target - audio.volume) / (ms / (1000 / fps));
                const t = setInterval(() => {
                    audio.volume = Math.max(0, Math.min(1, audio.volume + step));
                    if ((step > 0 && audio.volume >= target) || (step < 0 && audio.volume <= target)) {
                        clearInterval(t);
                        localStorage.setItem(VOL_KEY, String(audio.volume));
                    }
                }, 1000 / fps);
            }

            async function tryPlay() {
                try {
                    audio.muted = false;
                    audio.volume = parseFloat(localStorage.getItem(VOL_KEY) || '0.30');
                    await audio.play();
                    setBtn(true);
                    fadeTo(parseFloat(localStorage.getItem(VOL_KEY) || '0.35'), 700);
                } catch (e) {
                    // ì²« ì‚¬ìš©ì ì œìŠ¤ì²˜ ì „ ìë™ì¬ìƒì´ ë§‰íŒ ê²½ìš°: í•œ ë²ˆë§Œ íƒ­ ì´ë²¤íŠ¸ë¡œ ì–¸ë½
                    setBtn(false);
                    const unlock = async () => {
                        try {
                            await audio.play();
                            setBtn(true);
                            fadeTo(parseFloat(localStorage.getItem(VOL_KEY) || '0.35'), 700);
                        } catch { }
                        finally {
                            window.removeEventListener('pointerdown', unlock, { once: true });
                        }
                    };
                    window.addEventListener('pointerdown', unlock, { once: true });
                }
            }

            // â–¶ ìƒˆ í˜ì´ì§€ì—ì„œ ì¬ìƒ ìœ„ì¹˜ ë³µì›(ì´ì–´ë“£ê¸° í•µì‹¬)
            audio.addEventListener('loadedmetadata', () => {
                const pos = parseFloat(localStorage.getItem(POS_KEY) || '0');
                if (isFinite(pos) && pos > 0 && (!isFinite(audio.duration) || pos < audio.duration - 0.4)) {
                    audio.currentTime = pos;
                }
            });

            // â–¶ 0.7ì´ˆë§ˆë‹¤, ê·¸ë¦¬ê³  í˜ì´ì§€ ë– ë‚  ë•Œ í˜„ì¬ ìœ„ì¹˜ ì €ì¥
            const savePos = () => {
                if (isFinite(audio.currentTime)) localStorage.setItem(POS_KEY, String(audio.currentTime));
            };
            const posTimer = setInterval(savePos, 700);
            window.addEventListener('pagehide', savePos);

            // â–¶ ë²„íŠ¼ í† ê¸€: ìƒíƒœë¥¼ localStorageì— ì €ì¥ â†’ ë‹¤ìŒ í˜ì´ì§€ì—ë„ ê·¸ëŒ€ë¡œ ë°˜ì˜
            btn.addEventListener('click', async () => {
                if (audio.paused) {
                    localStorage.setItem(STATE_KEY, 'on');
                    await tryPlay();
                } else {
                    audio.pause();
                    setBtn(false);
                    localStorage.setItem(STATE_KEY, 'off');
                }
            });

            // â–¶ ì²« ì§„ì… ì‹œ ìƒíƒœ/ìœ„ì¹˜ ë°˜ì˜
            if ((localStorage.getItem(STATE_KEY) ?? 'on') === 'on') {
                tryPlay();
            } else {
                setBtn(false);
            }

            // â–¶ íƒ­ì„ ë‹¤ì‹œ ë³¼ ë•Œ, ì¼œë‘ì—ˆëŠ”ë° ë©ˆì¶° ìˆìœ¼ë©´ ì¦‰ì‹œ ì¬ê°œ
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && localStorage.getItem(STATE_KEY) === 'on' && audio.paused) {
                    tryPlay();
                }
            });
        })();
    </script>

    <!-- âœ¿ custom cursor -->
    <script>
        (function () {
            const c = document.getElementById('cursor'); if (!c) return;
            const move = (x, y) => { c.style.left = x + 'px'; c.style.top = y + 'px'; };
            window.addEventListener('pointermove', e => move(e.clientX, e.clientY), { passive: true });
            window.addEventListener('pointerdown', () => c.classList.add('active'));
            window.addEventListener('pointerup', () => c.classList.remove('active'));
            document.addEventListener('mouseleave', () => c.style.opacity = '0');
            document.addEventListener('mouseenter', () => c.style.opacity = '1');
        })();
    </script>

    <!-- today ì—°ë™ + ì„¤ëª… ë§¤í•‘ -->
    <script>
        const EN_NAME = { 'hydrangea': 'HYDRANGEA', 'babybreath': "BABY'S BREATH", 'lavender': 'LAVENDER', 'freesia': 'FREESIA', 'daisy': 'DAISY', 'white-lily': 'WHITE LILY', 'lilac': 'LILAC', 'white-tulip': 'WHITE TULIP', 'sunflower': 'SUNFLOWER', 'peony': 'PEONY', 'forgetmenot': 'FORGET-ME-NOT', 'lotus': 'LOTUS' };
        const FLOWER_DESC = { /* ê¸°ì¡´ ë§¤í•‘ ìœ ì§€ */ };
        const $ = (q, r = document) => r.querySelector(q); const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
        const z = n => String(n).padStart(2, '0'); const fmt = d => `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}`;
    </script>

    <!-- today ë°ì´í„° ë¸Œë¦¬ì§€ + ì¹´ë“œ ë Œë” -->
    <script>
        const DataBridge = (function () {
            const nz = n => String(n).padStart(2, '0');
            const normalize = (x) => { if (!x) return ''; const m = String(x).trim().match(/(\d{4})[./-](\d{1,2})[./-](\d{1,2})/); return m ? `${m[1]}-${nz(m[2])}-${nz(m[3])}` : ''; };
            function readAny(dateStr) {
                const out = { date: dateStr, quote: null, flower: null, props: [], bg: null, capture: null, desc: null, sub: null };
                try {
                    const raw = localStorage.getItem('moodiary_today');
                    if (raw) {
                        const v = JSON.parse(raw);
                        const data = Array.isArray(v) ? (v.find(it => normalize(it?.date) === dateStr) || null) : (v[dateStr] || v[dateStr?.replace(/-/g, '.')] || v[dateStr?.replace(/-/g, '/')] || null);
                        if (data) {
                            out.quote = (data.oneLine || data.feeling || '').toString().trim() || null;
                            out.sub = data.feeling || out.sub;
                            if (Array.isArray(data.flowers) && data.flowers[0]) {
                                const f = data.flowers[0]; const slug = f.slug || f.id || '';
                                out.flower = { id: slug || null, name: EN_NAME[slug] || f.name || '', img: f.img || (slug ? `img/flowers/${slug}.svg` : undefined) };
                            }
                            if (Array.isArray(data.props)) out.props = data.props.slice(0, 2);
                            if (data.desc) out.desc = data.desc;
                            if (data.capture) out.capture = data.capture;
                            if (data.weather) out.weather = data.weather;
                        }
                    }
                } catch (e) { console.warn('today ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨', e); }
                try {
                    const keys = Object.keys(localStorage);
                    for (const k of keys) {
                        if (!k.endsWith(dateStr)) continue;
                        const raw = localStorage.getItem(k); if (!raw) continue;
                        let v = null; try { v = JSON.parse(raw); } catch { v = raw; }
                        if (/capture/i.test(k) && typeof v === 'string' && v.startsWith('data:image')) out.capture = v;
                    }
                    const map = JSON.parse(localStorage.getItem('photos_by_date') || '{}');
                    if (map[dateStr] && map[dateStr].length) out.capture = map[dateStr][map[dateStr].length - 1];
                    const single = localStorage.getItem(`garden_capture_${dateStr}`); if (single) out.capture = single;
                } catch (e) { console.warn(e); }
                return out;
            }
            function bestDate() {
                const keys = Object.keys(localStorage), dRe = /\d{4}-\d{2}-\d{2}$/; const dates = [];
                for (const k of keys) { const m = k.match(dRe); if (m) dates.push(m[0]); }
                dates.sort();
                const t = new Date(), td = `${t.getFullYear()}-${z(t.getMonth() + 1)}-${z(t.getDate())}`;
                return dates.includes(td) ? td : (dates.at(-1) || td);
            }
            return { readAny, bestDate };
        })();

        function renderCard(payload) {
            const img = $('#flowerImg'), title = $('#cardTitle'), quote = $('#cardQuote'), sub = $('#cardSub');
            const f = (payload.flowers && payload.flowers[0]) || (payload.flower ? { slug: payload.flower.id, name: payload.flower.name, img: payload.flower.img } : null);
            if (f && (f.img || f.slug)) { img.src = f.img || `img/flowers/${f.slug}.svg`; img.style.display = 'block'; } else { img.removeAttribute('src'); img.style.display = 'none'; }
            title.textContent = f ? (f.name || (f.slug ? f.slug.toUpperCase() : 'ì˜¤ëŠ˜ì˜ ê½ƒ')) : 'âœ¿';
            quote.textContent = (payload.feeling && String(payload.feeling).trim()) ? payload.feeling : 'ì˜¤ëŠ˜ì˜ í•œ ì¤„ ê¸°ë¶„ì„ ì ì–´ì£¼ì„¸ìš”.';
            sub.textContent = '';
            let desc = payload.desc; const slug = f?.slug || payload?.flower?.id;
            if (!desc && slug && FLOWER_DESC[slug]) desc = FLOWER_DESC[slug];
            $('#descPanelText').textContent = desc || '';
        }
        function mapToCardPayload(d) {
            if (!d || typeof d !== 'object') return { feeling: '', flowers: [], props: [], keywords: [], weather: null, desc: null };
            const feeling = (d.quote || d.sub || '').toString().trim();
            const flowers = d.flower ? [{
                name: d.flower.name || '',
                slug: d.flower.id || '',
                img: d.flower.img || (d.flower.id ? `img/flowers/${d.flower.id}.svg` : '')
            }] : [];
            const props = Array.isArray(d.props) ? d.props.slice(0, 2) : [];
            const keywords = Array.isArray(d.keywords) ? d.keywords : [];   // ğŸ‘ˆ ì¶”ê°€
            const weather = d.weather || null;
            return { feeling, flowers, props, keywords, weather, desc: d.desc };
        }

        function loadForDate(dateStr) {
            const raw = DataBridge.readAny(dateStr);
            const payload = mapToCardPayload(raw);
            renderCard(payload);

            // ğŸ‘‡ í‚¤ì›Œë“œ í‘œì‹œ
            const kwBox = document.getElementById('mdKeywords');
            kwBox.innerHTML = '';
            if (payload.keywords && payload.keywords.length) {
                payload.keywords.forEach(k => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = k.label || k; // ê°ì²´ë©´ label, ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ
                    kwBox.appendChild(chip);
                });
            }

            document.getElementById('dateBadge').textContent = dateStr;
            setCanvasFromCapture(dateStr);
        }

        // ğŸ” ë‹¬ë ¥ ë°‘ ë©”ëª¨ ë°•ìŠ¤ ë Œë”ë§ (ì •ì‚¬ê° ë°•ìŠ¤ ì•ˆì— 4ê°œ í•­ëª© ê³ ì • ì¶œë ¥)
        function renderMiniDetails(dateStr) {
            const box = document.querySelector('.mini-details');
            if (!box) return;

            const raw = DataBridge.readAny(dateStr) || {};
            // today.html ì €ì¥ êµ¬ì¡° ê¸°ì¤€: oneLine, feeling, flowers[0], weather, desc :contentReference[oaicite:4]{index=4}

            const oneLine = (raw.quote || '').trim();             // ì˜¤ëŠ˜ì˜ í•œì¤„ (oneLineì„ DataBridgeê°€ quoteë¡œ ë§¤í•‘)
            const feeling = (raw.sub || '').trim();               // ê°ì •(í‚¤ì›Œë“œ ë¼ë²¨)
            const flowerName =
                (raw.flower && (raw.flower.name || EN_NAME[raw.flower.id])) || '';
            const weatherText = raw.weather ? (WEATHER_LABEL[raw.weather] || raw.weather) : '';

            // ë¹„ì–´ìˆì–´ë„ 4ì¤„ í‹€ì€ ìœ ì§€ â†’ ì‚¬ìš©ìì—ê²Œ ì–´ë–¤ í•­ëª©ì´ ë¹„ì–´ìˆëŠ”ì§€ ëª…í™•
            box.innerHTML = `
      <div class="md-row">
        <div class="md-label">ì˜¤ëŠ˜ì˜ í•œì¤„</div>
        <div class="md-val">${oneLine || '<span style="color:#aaa">â€”</span>'}</div>
      </div>
      <div class="md-row">
        <div class="md-label">ê°ì •</div>
        <div class="md-val">${feeling || '<span style="color:#aaa">â€”</span>'}</div>
      </div>
      <div class="md-row">
        <div class="md-label">ì˜¤ëŠ˜ì˜ ê½ƒ</div>
        <div class="md-val">${flowerName || '<span style="color:#aaa">â€”</span>'}</div>
      </div>
      <div class="md-row">
        <div class="md-label">ì„ íƒí•œ ë‚ ì”¨</div>
        <div class="md-val">${weatherText || '<span style="color:#aaa">â€”</span>'}</div>
      </div>
    `;
        }


        // ğŸ” ê¸°ì¡´ loadForDate í›…ì— ì—°ê²°(ì´ë¯¸ ë˜í•‘í–ˆë‹¤ë©´ ìƒëµ)
        if (typeof loadForDate === 'function') {
            const __old = loadForDate;
            window.loadForDate = function (dateStr) {
                __old(dateStr);          // ê¸°ì¡´ ì¹´ë“œ/ì—ë””í„° ë Œë” ìœ ì§€
                renderMiniDetails(dateStr); // ë©”ëª¨ ë°•ìŠ¤ ê°±ì‹ 
            };
        }

        // â± ì²« ë¡œë“œ ì‹œ ê¸°ë³¸ ë‚ ì§œë¡œ í•œë²ˆ ë Œë”
        document.addEventListener('DOMContentLoaded', () => {
            const def = DataBridge.bestDate();
            renderMiniDetails(def);
        });

    </script>
    <script>
        /* ==== ë‚ ì§œë³„ ë©”ëª¨ ì €ì¥ì†Œ ==== */
        const MEMO_KEY_PREFIX = 'moodiary_memo_';
        const memoEls = {
            input: null, saveBtn: null, clearBtn: null, toast: null, dateLabel: null
        };
        function memoKey(dateStr) { return MEMO_KEY_PREFIX + dateStr; }
        function getMemo(dateStr) { return localStorage.getItem(memoKey(dateStr)) || ''; }
        function setMemo(dateStr, text) {
            if (text?.trim()) localStorage.setItem(memoKey(dateStr), text.trim());
            else localStorage.removeItem(memoKey(dateStr));
        }
        function hasMemo(dateStr) { return !!localStorage.getItem(memoKey(dateStr)); }

        /* UI ì—…ë°ì´íŠ¸ */
        function updateMemoUI(dateStr) {
            if (!memoEls.input) {
                memoEls.input = document.getElementById('memoInput');
                memoEls.saveBtn = document.getElementById('memoSaveBtn');
                memoEls.clearBtn = document.getElementById('memoClearBtn');
                memoEls.toast = document.getElementById('memoSavedToast');
                memoEls.dateLabel = document.getElementById('memoDateLabel');

                memoEls.saveBtn?.addEventListener('click', () => {
                    const d = (document.getElementById('dateBadge')?.textContent || '').trim();
                    setMemo(d, memoEls.input.value);
                    showMemoToast();
                    // ìº˜ë¦°ë”ì— ë©”ëª¨ ì•„ì´ì½˜ ë°˜ì˜
                    if (typeof refreshCalendarMemoIcons === 'function') refreshCalendarMemoIcons();
                });
                memoEls.clearBtn?.addEventListener('click', () => {
                    const d = (document.getElementById('dateBadge')?.textContent || '').trim();
                    setMemo(d, '');
                    memoEls.input.value = '';
                    if (typeof refreshCalendarMemoIcons === 'function') refreshCalendarMemoIcons();
                });
            }
            if (memoEls.dateLabel) memoEls.dateLabel.textContent = dateStr;
            if (memoEls.input) memoEls.input.value = getMemo(dateStr);
        }

        function showMemoToast() {
            if (!memoEls.toast) return;
            memoEls.toast.hidden = false;
            clearTimeout(showMemoToast._t);
            showMemoToast._t = setTimeout(() => memoEls.toast.hidden = true, 1200);
        }
    </script>

    <!-- ì¢Œì¸¡ ë‹¬ë ¥/ì¹´ë“œ ë Œë” -->
    <script>
        (function () {
            const calGrid = $('#calGrid'), mname = $('#mname'), ytext = $('#ytext'), info = $('#leftInfo'), dateBadge = $('#dateBadge');
            const MONTHS = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            let selDate = (new URL(location.href)).searchParams.get('date') || DataBridge.bestDate();
            let cur = new Date(selDate);

            function buildCalendar(d) {
                calGrid.innerHTML = ''; const y = d.getFullYear(), m = d.getMonth();
                mname.textContent = MONTHS[m]; ytext.textContent = y;
                const first = new Date(y, m, 1), start = first.getDay(), last = new Date(y, m + 1, 0).getDate();
                for (let i = 0; i < start; i++) { const div = document.createElement('div'); div.className = 'cell off'; calGrid.appendChild(div); }
                for (let day = 1; day <= last; day++) {
                    const dateStr = `${y}-${z(m + 1)}-${z(day)}`;
                    const cell = document.createElement('button'); cell.className = 'cell'; cell.dataset.day = String(day);
                    if (dateStr === fmt(new Date())) cell.classList.add('today');
                    if (dateStr === selDate) cell.classList.add('sel');
                    const data = DataBridge.readAny(dateStr);
                    const hasRecord = !!(data.quote || data.flower || (data.props && data.props.length));
                    const hasCapture = !!data.capture;
                    if (hasRecord) {
                        const flower = document.createElement('span');
                        flower.className = 'mark-flower' + (hasCapture ? ' orange' : '');
                        flower.textContent = 'âœ¿';
                        cell.appendChild(flower);
                    }
                    cell.addEventListener('click', () => {
                        selDate = dateStr;
                        $$('.cell.sel', calGrid).forEach(c => c.classList.remove('sel'));
                        cell.classList.add('sel');
                        loadForDate(selDate);
                        refreshOptions();
                        syncHeadline(selDate);

                        (function () {
                            const calGrid = document.getElementById('calGrid');

                            // ë‹¬ë ¥ ì¹¸ í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì •
                            calGrid?.addEventListener('click', (e) => {
                                const cell = e.target.closest('.cell');
                                if (!cell || cell.classList.contains('off')) return;

                                // ê¸°ì¡´ ì„ íƒ/ë Œë”ë§ ì²˜ë¦¬
                                const dateStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${cell.dataset.day.padStart(2, '0')}`;
                                window.loadForDate(dateStr);

                                // âœ… ë‹¬ë ¥ì¹¸ í´ë¦­ ì‹œë§Œ ì—¬ë°± ì¶”ê°€
                                document.querySelectorAll('.snap-section').forEach(sec => {
                                    sec.style.scrollMarginTop = "calc(var(--header-h) + 20px)"; // í—¤ë” ë†’ì´ + ì¶”ê°€ ì—¬ë°±
                                });

                                // ì•½ê°„ì˜ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ (ì›í•˜ëŠ” ê²½ìš°)
                                document.getElementById('snap-day').scrollIntoView({ behavior: "smooth" });
                            });

                            // day.html ì§ì ‘ ì§„ì… ì‹œ ê¸°ë³¸ ì—¬ë°± ìœ ì§€
                            window.addEventListener("DOMContentLoaded", () => {
                                document.querySelectorAll('.snap-section').forEach(sec => {
                                    sec.style.scrollMarginTop = "var(--header-h)";
                                });
                            });
                        })();
                    });
                    calGrid.appendChild(cell);
                }
                info.textContent = `ê¸°ë¡ì„ í´ë¦­í•´ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆì–´ìš”. (${y}-${z(m + 1)})`;
                dateBadge.textContent = selDate;
            }

            window.loadForDate = function (dateStr) {
                const raw = DataBridge.readAny(dateStr);
                const payload = mapToCardPayload(raw);
                renderCard(payload);
                dateBadge.textContent = dateStr;
            };

            $('#prevM').addEventListener('click', () => { cur.setMonth(cur.getMonth() - 1); buildCalendar(cur); });
            $('#nextM').addEventListener('click', () => { cur.setMonth(cur.getMonth() + 1); buildCalendar(cur); });
            $('#todayM').addEventListener('click', () => { const t = new Date(); cur = new Date(t); selDate = DataBridge.bestDate(); buildCalendar(cur); loadForDate(selDate); refreshOptions(); syncHeadline(selDate); });
            $('#goDiaryBtn').addEventListener('click', () => location.href = 'day.html');

            buildCalendar(cur);
            loadForDate(selDate);
            syncHeadline(selDate);

            // ... (ì„¸ì…˜ 2 ë¯¸ë‹ˆ ë‹¬ë ¥ IIFE ì•ˆìª½, buildCalendar ì •ì˜ ë°”ë¡œ ì•„ë˜ ë“± ì ì ˆí•œ ê³³)
            window.showOnMiniCalendar = function (dateStr) {
                try {
                    // 1) ì›” ì´ë™ + ì„ íƒ ë‚ ì§œ ë™ê¸°í™”
                    selDate = dateStr;
                    cur = new Date(dateStr);
                    buildCalendar(cur);
                    // 2) ì¹´ë“œ/ì˜µì…˜/í—¤ë“œë¼ì¸ ë™ê¸°í™”
                    loadForDate(selDate);
                    refreshOptions();
                    syncHeadline(selDate);
                } catch (e) { console.warn('showOnMiniCalendar ì˜¤ë¥˜', e); }
            };
        })();

        const KOREAN_DAY = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        function toKDateStr(dStr) { const d = dStr ? new Date(dStr) : new Date(); if (isNaN(d)) return 'â€”'; return `${d.getFullYear()}ë…„ ${d.getMonth() + 1}ì›” ${d.getDate()}ì¼ (${KOREAN_DAY[d.getDay()]})`; }
        function syncHeadline(dateStr) {
            const el = document.getElementById('headlineDate');
            if (!el) return;
            el.textContent = toKDateStr(dateStr);
            if (window.setNeighborLabels) window.setNeighborLabels(dateStr);
        };

        (function () {
            const prevBtn = document.getElementById('prevDay');
            const nextBtn = document.getElementById('nextDay');

            function addDays(base, diff) {
                const d = new Date(base); d.setDate(d.getDate() + diff);
                const z = n => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}`;
            }

            window.setNeighborLabels = function (currentDateStr) {
                const prev = addDays(currentDateStr, -1);
                const next = addDays(currentDateStr, +1);
                const pv = new Date(prev), nx = new Date(next);
                const short = dt => `${dt.getMonth() + 1}/${dt.getDate()}`;
                if (prevBtn) prevBtn.textContent = `âŸµ ${short(pv)}`;
                if (nextBtn) nextBtn.textContent = `${short(nx)} âŸ¶`;
            };

            function changeDay(diff) {
                const base = (document.getElementById('dateBadge')?.textContent || '').trim()
                    || (function () { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; })();
                const d = new Date(base); d.setDate(d.getDate() + diff);
                const next = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

                loadForDate(next);
                refreshOptions();
                syncHeadline(next);
                if (window.setNeighborLabels) window.setNeighborLabels(next);
            }

            prevBtn?.addEventListener('click', () => changeDay(-1));
            nextBtn?.addEventListener('click', () => changeDay(1));

            const initial = (document.getElementById('dateBadge')?.textContent || '').trim()
                || (function () { const b = DataBridge.bestDate(); const badge = document.getElementById('dateBadge'); if (badge) badge.textContent = b; return b; })();
            syncHeadline(initial);
            if ((document.getElementById('headlineDate')?.textContent || '').trim() === 'â€”') {
                const d = (document.getElementById('dateBadge')?.textContent || '').trim() || fmt(new Date());
                syncHeadline(d);
            }
            if (window.setNeighborLabels) window.setNeighborLabels((document.getElementById('dateBadge')?.textContent || '').trim() || fmt(new Date()));
        })();
    </script>

    <!-- ì˜µì…˜ ë Œë” (ë°°ê²½: SVG4, ì¸ë„¤ì¼ 64Ã—64 ê³ ì •) -->
    <script>
        const BG_IMAGES = ['img/g/garden1.svg', 'img/g/garden2.svg', 'img/g/garden3.svg', 'img/g/garden4.svg'];
        (function initStaticOptions() {
            const canvas = $('#canvas'); const assetsBg = $('#assetsBg'); assetsBg.innerHTML = '';
            BG_IMAGES.forEach(src => {
                const b = document.createElement('button');
                b.className = 'thumb'; b.innerHTML = `<img src="${src}" alt="ë°°ê²½">`;
                b.addEventListener('click', () => { canvas.style.backgroundImage = `url('${src}')`; });
                assetsBg.appendChild(b);
            });
        })();
        // ì»¤ìŠ¤í…€ ì´ë¯¸ì§€(img/flowers2/xxx2.svg)ë¥¼ 'ê¸°ë³¸ ê½ƒ' ê²½ë¡œ(img/flowers/xxx.svg)ë¡œ ê°•ì œ ë³€í™˜
        function baseFlowerSrc(slug, img) {
            // slugê°€ ê°€ì¥ ì •í™•í•¨
            if (slug) return `img/flowers/${slug}.svg`;

            // slugê°€ ì—†ê³  imgë§Œ ìˆì„ ë•Œ, íŒŒì¼ëª…ì—ì„œ slug ìœ ì¶”
            // ì˜ˆ: img/flowers2/babybreath2.svg â†’ babybreath
            if (img) {
                const m = img.match(/flowers2\/(.+?)2\.svg$/);
                if (m && m[1]) return `img/flowers/${m[1]}.svg`;
            }
            // ìµœí›„ í´ë°±: ê·¸ëŒ€ë¡œ ë°˜í™˜(ê¹¨ì ¸ë³´ì´ë©´ íŒŒì¼ì´ ì—†ë‹¤ëŠ” ëœ»)
            return img || '';
        }
        /* â‘  ì†Œí’ˆ/ë‚ ì”¨/ê½ƒë³„ ì´ˆê¸° í¬ê¸° ë§µ */
        const SIZE_MAP = {
            // ì†Œí’ˆ
            'grass.svg': 160,
            'cloud.svg': 220,
            'fence.svg': 200,
            'star.svg': 70,
            'butterfly.svg': 80,

            // ë‚ ì”¨
            'sun.svg': 120,
            'rain.svg': 140,
            'snow.svg': 160,
            'cloudy.svg': 150,

            // ê½ƒ (slug ê¸°ì¤€ë„ ì§€ì›)
            'sunflower': 260,
            'rose': 220,
            'daisy': 200,
        };

        /* â‘¡ íŒŒì¼ëª…/ìŠ¬ëŸ¬ê·¸ì—ì„œ í‚¤ ë½‘ê¸° */
        function keyFromSrc(src) {
            if (!src) return '';
            // .../folder/name.svg â†’ name.svg
            const base = src.split('/').pop();
            // name.svg â†’ name
            const name = (base || '').replace(/\.\w+$/, '');
            return name;
        }

        /* â‘¢ ì´ˆê¸° í¬ê¸° ê³„ì‚°(ì—†ìœ¼ë©´ fallback ì‚¬ìš©) */
        function getInitWidth(srcOrSlug, fallback = 120) {
            const key = keyFromSrc(srcOrSlug) || String(srcOrSlug);
            if (SIZE_MAP[key] != null) return SIZE_MAP[key];
            // slugë¡œë„ í•œ ë²ˆ ë” ì‹œë„
            if (SIZE_MAP[srcOrSlug] != null) return SIZE_MAP[srcOrSlug];
            return fallback;
        }

        /* â‘£ addObj ë˜í¼: í•­ìƒ ì ì ˆí•œ widthë¡œ í˜¸ì¶œ */
        function placeObj(srcOrSlug, fallback = 120) {
            const w = getInitWidth(srcOrSlug, fallback);
            // addObjëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì˜µì…˜ widthë§Œ ì£¼ì…)
            return addObj(srcOrSlug, { width: w });
        }
        function refreshOptions() {
            const dateStr = (document.getElementById('dateBadge')?.textContent || '').trim();
            const d = DataBridge.readAny(dateStr);
            const payload = mapToCardPayload(d);

            // âœ… ê½ƒ(ì™¼ìª½)
            const assetsFlowerCol = document.getElementById('assetsFlowerCol');
            if (assetsFlowerCol) assetsFlowerCol.innerHTML = '';
            const f = payload.flowers && payload.flowers[0];
            if (assetsFlowerCol) {
                const wrap = document.createElement('div'); wrap.className = 'thumbs'; // ë‚´ë¶€ thumbsëŠ” ì´ë¯¸ 64x64 ê·¸ë¦¬ë“œ
                // ì‹¤ì œ ê½ƒ ì•„ì´í…œ 1ê°œ
                if (f) {
                    const baseSrc = baseFlowerSrc(f.slug, f.img);
                    const btn = document.createElement('button');
                    btn.className = 'thumb';
                    btn.innerHTML = `<img src="${baseSrc}" alt="flower">`;
                    // ê½ƒ
                    btn.addEventListener('click', () => addObj(baseSrc, { width: 200 }));

                    // ë‚ ì”¨
                    btn.addEventListener('click', () => addObj(wsrc, { width: 420 }));

                    // ì†Œí’ˆ (ë¹„ìŠ·í•˜ê²Œ addObj í˜¸ì¶œí•˜ëŠ” ë¶€ë¶„ ì°¾ì•„ì„œ ìˆ˜ì •)
                    btn.addEventListener('click', () => addObj(psrc, { width: 80 }));
                    assetsFlowerCol.appendChild(btn);
                }
                // ë¹ˆ ì¹¸ 1ê°œ (í•­ìƒ)
                const blank1 = document.createElement('div');
                blank1.className = 'thumb blank';
                blank1.textContent = '';
                assetsFlowerCol.appendChild(blank1);
            }

            // âœ… ë‚ ì”¨(ì˜¤ë¥¸ìª½)
            const assetsWeatherCol = document.getElementById('assetsWeatherCol');
            if (assetsWeatherCol) assetsWeatherCol.innerHTML = '';
            if (assetsWeatherCol) {
                if (payload && payload.weather) {
                    const wsrc = `img/weather/${payload.weather}.svg`;
                    const btn = document.createElement('button');
                    btn.className = 'thumb';
                    btn.innerHTML = `<img src="${wsrc}" alt="${payload.weather}">`;
                    btn.addEventListener('click', () => addObj(wsrc, { width: 320 }));
                    assetsWeatherCol.appendChild(btn);
                }
                // ë¹ˆ ì¹¸ 1ê°œ (í•­ìƒ)
                const blank2 = document.createElement('div');
                blank2.className = 'thumb blank';
                blank2.textContent = '';
                assetsWeatherCol.appendChild(blank2);
            }

            // âœ… ì†Œí’ˆ(ê·¸ëŒ€ë¡œ ìœ ì§€)
            const assetsProps = document.getElementById('assetsProps');
            if (assetsProps) {
                assetsProps.innerHTML = '';
                const picked = (payload.props || []);
                if (picked.length) {
                    const wrap = document.createElement('div'); wrap.className = 'thumbs'; assetsProps.appendChild(wrap);
                    picked.forEach(slug => {
                        for (let i = 1; i <= 4; i++) {
                            const src = `img/sp/${slug}${i}.svg`;
                            const b = document.createElement('button'); b.className = 'thumb';
                            b.innerHTML = `<img src="${src}" alt="${slug}${i}">`;
                            b.addEventListener('click', () => addObj(src, { width: 80 }));
                            wrap.appendChild(b);
                        }
                    });
                }

                // í•­ìƒ ë³´ì´ëŠ” ê³ ì • ì†Œí’ˆë“¤
                const FIXED_PROP_SLUGS = ['butterfly', 'fence', 'grass', 'star', 'cloud'];
                const wrapFixed = document.createElement('div'); wrapFixed.className = 'thumbs';
                FIXED_PROP_SLUGS.forEach(slug => {
                    for (let i = 1; i <= 4; i++) {
                        const src = `img/sp/${slug}${i}.svg`;
                        const b = document.createElement('button'); b.className = 'thumb';
                        b.innerHTML = `<img src="${src}" alt="${slug}${i}">`;
                        b.addEventListener('click', () => addObj(src, { width: 80 }));
                        wrapFixed.appendChild(b);
                    }
                });
                assetsProps.appendChild(wrapFixed);
            }
        }

    </script>

    <!-- ì—ë””í„° ì½”ì–´ -->
    <script>
        (() => {
            const $ = (q, r = document) => r.querySelector(q); const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));
            const canvas = $('#canvas'); let current = null, box = null, dragState = null;
            window.addObj = function addObj(src, init = {}) { const img = new Image(); img.crossOrigin = 'anonymous'; img.decoding = 'async'; img.referrerPolicy = 'no-referrer'; img.draggable = false; img.className = 'obj'; img.onload = () => mountObj(img, init); img.onerror = () => mountObj(img, init); img.src = src; };
            function mountObj(img, init) {
                canvas.appendChild(img);

                const cw = canvas.clientWidth || 800;
                const ch = canvas.clientHeight || 500;
                const base = Math.min(cw, ch);

                // width/height ë‘˜ ë‹¤ ì§€ì› (ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ìº”ë²„ìŠ¤ì˜ ì•½ 22%)
                let w = (typeof init.width === 'number') ? init.width : null;
                let h = (typeof init.height === 'number') ? init.height : null;

                if (!w && !h) w = Math.round(base * 0.22); // ê¸°ë³¸ í¬ê¸° ìƒí–¥

                // ì‚¬ì´ì¦ˆ ì ìš©
                img.style.position = 'absolute';
                if (h && !w) {
                    img.style.height = `${h}px`;
                    img.style.width = 'auto';
                } else {
                    img.style.width = `${w}px`;
                    img.style.height = 'auto';
                }

                // ì„¼í„° ë°°ì¹˜
                const boxSize = h || w || Math.round(base * 0.22);
                const x = (init.left ?? cw * 0.5 - boxSize * 0.5);
                const y = (init.top ?? ch * 0.5 - boxSize * 0.5);
                img.style.left = `${Math.max(0, Math.min(cw - boxSize, x))}px`;
                img.style.top = `${Math.max(0, Math.min(ch - boxSize, y))}px`;

                // ì„ íƒ/í¸ì§‘íˆ´ ìœ ì§€
                if (typeof makeInteractive === 'function') makeInteractive(img);
                if (typeof select === 'function') select(img);
            }

            function select(el) {
                current = el; if (!box) {
                    box = document.createElement('div'); box.className = 'selbox';
                    ['nw', 'ne', 'sw', 'se', 'rot'].forEach(k => {
                        const h = document.createElement('div');
                        h.className = 'handle h-' + k;
                        box.appendChild(h);
                    });
                    // âœ• ë‹«ê¸° ë²„íŠ¼ ì¶”ê°€
                    const closeBtn = document.createElement('div');
                    closeBtn.className = 'handle h-close';
                    closeBtn.textContent = 'âœ•';
                    box.appendChild(closeBtn);

                    canvas.appendChild(box);

                    box.querySelector('.h-rot').addEventListener('pointerdown', rotStart);
                    box.querySelector('.h-se').addEventListener('pointerdown', rsStart('se'));
                    box.querySelector('.h-nw').addEventListener('pointerdown', rsStart('nw'));
                    box.querySelector('.h-ne').addEventListener('pointerdown', rsStart('ne'));
                    box.querySelector('.h-sw').addEventListener('pointerdown', rsStart('sw'));

                    // âœ• í´ë¦­ ì‹œ ì‚­ì œ
                    closeBtn.addEventListener('pointerdown', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        deleteSelected();
                    });
                }

                updateBox();
            }
            function deleteSelected() {
                if (!current) return;
                const toRemove = current;
                deselect();           // ì„ íƒë°•ìŠ¤ ìˆ¨ê¸°ê¸°
                toRemove.remove();    // ì´ë¯¸ì§€ ì œê±°
                schedulePersist();    // ìƒíƒœ ì €ì¥(ìˆìœ¼ë©´)
            }

            /* ì„ íƒëœ ê²Œ ì—†ì–´ë„ ë™ì‘í•˜ë„ë¡ í‚¤ë³´ë“œ Delete/Backspace ì§€ì›(ì„ íƒì‚¬í•­) */
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    if (current) { e.preventDefault(); deleteSelected(); }
                }
            });

            /* ì €ì¥ ë¡œì§: í”„ë¡œì íŠ¸ì— ì´ë¯¸ ì €ì¥ í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  í˜¸ì¶œ */
            function schedulePersist() {
                // ë„ˆì˜ ê¸°ì¡´ ì €ì¥ í›…ì´ ìˆìœ¼ë©´ ê·¸ê²ƒë¶€í„°
                if (typeof window.saveGardenState === 'function') {
                    try { window.saveGardenState(); return; } catch { }
                }
                // ì—†ìœ¼ë©´ ì¸ë¼ì¸ ë°±ì—… ì €ì¥
                try { persistStateInline(); } catch { }
            }

            /* ì¸ë¼ì¸ ë°±ì—… ì €ì¥: í˜„ì¬ ìº”ë²„ìŠ¤ ìƒíƒœë¥¼ localStorageì— ì €ì¥ */
            function persistStateInline() {
                const STATE_KEY = (date) => `garden_state_${date}`;
                const dateStr = (document.getElementById('dateBadge')?.textContent || '').trim();
                if (!dateStr) return;

                const items = Array.from(canvas.querySelectorAll('img.obj')).map(el => ({
                    src: el.getAttribute('src'),
                    left: parseFloat(el.style.left) || 0,
                    top: parseFloat(el.style.top) || 0,
                    width: parseFloat(el.style.width) || el.getBoundingClientRect().width,
                    angle: getAngle(el) || 0
                }));

                const bg = (canvas.style.backgroundImage || '')
                    .replace(/^url\(["']?/, '').replace(/["']?\)$/, '');

                const state = { bg: bg || null, items };
                localStorage.setItem(STATE_KEY(dateStr), JSON.stringify(state));

                // ë‹¬ë ¥ âœ¿ ë§ˆí¬ ì—…ë°ì´íŠ¸(ìˆìœ¼ë©´ íšŒìƒ‰/ì£¼í™© ê°±ì‹ )
                try {
                    const calGrid = document.getElementById('calGrid');
                    const sel = calGrid?.querySelector('.cell.sel');
                    if (sel) {
                        let mark = sel.querySelector('.mark-flower');
                        if (!mark && (items.length || bg)) {
                            mark = document.createElement('span');
                            mark.className = 'mark-flower';
                            mark.textContent = 'âœ¿';
                            sel.appendChild(mark);
                        }
                        // ìº¡ì²˜ê°€ ìˆì„ ë•ŒëŠ” ì£¼í™©ì´ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ìƒíƒœë§Œ ì €ì¥í•˜ë¯€ë¡œ íšŒìƒ‰ ìœ ì§€
                        if (mark) mark.classList.remove('orange');
                    }
                } catch { }
            }

            function deselect() { current = null; if (box) box.style.display = 'none'; }
            document.getElementById('btnDeselect')?.addEventListener('click', deselect);
            document.getElementById('btnClear')?.addEventListener('click', () => {
                (() => {
                    const canvas = document.getElementById('canvas');
                    const calGrid = document.getElementById('calGrid');
                    const STATE_KEY = (date) => `garden_state_${date}`;

                    function saveEmptyState(dateStr) {
                        localStorage.setItem(STATE_KEY(dateStr), JSON.stringify({ items: [] }));
                    }

                    function removeCapture(dateStr) {
                        localStorage.removeItem(`garden_capture_${dateStr}`);
                        try {
                            const map = JSON.parse(localStorage.getItem('photos_by_date') || '{}');
                            if (map[dateStr]) {
                                delete map[dateStr];
                                localStorage.setItem('photos_by_date', JSON.stringify(map));
                            }
                        } catch { }
                    }

                    function clearCanvasUI() {
                        // 1) ì˜¤ë¸Œì íŠ¸ë§Œ ì§€ìš°ê¸°
                        Array.from(canvas.querySelectorAll('img')).forEach(el => el.remove());
                        canvas.style.backgroundImage = 'none';

                        // 2) ì„ íƒ í•´ì œ + í¸ì§‘íˆ´ì€ ìˆ¨ê¸°ê¸°
                        current = null;
                        if (box) box.style.display = 'none';
                    }

                    function updateCalendarMarkToGray(dateStr) {
                        const sel = calGrid?.querySelector('.cell.sel');
                        if (!sel) return;
                        const mark = sel.querySelector('.mark-flower');
                        if (mark) mark.classList.remove('orange');
                        if (!mark) {
                            try {
                                const data = (window.DataBridge && DataBridge.readAny) ? DataBridge.readAny(dateStr) : null;
                                const hasRecord = !!(data && (data.quote || data.flower || (data.props && data.props.length)));
                                if (hasRecord) {
                                    const flower = document.createElement('span');
                                    flower.className = 'mark-flower';
                                    flower.textContent = 'âœ¿';
                                    sel.appendChild(flower);
                                }
                            } catch { }
                        }
                    }

                    document.getElementById('btnClear')?.addEventListener('click', () => {
                        const dateStr = (document.getElementById('dateBadge')?.textContent || '').trim();
                        if (!dateStr) return;

                        clearCanvasUI();
                        saveEmptyState(dateStr);
                        removeCapture(dateStr);
                        updateCalendarMarkToGray(dateStr);
                    });
                })();
            });
            canvas.addEventListener('pointerdown', e => { if (e.target === canvas) deselect(); });
            function getAngle(el) { const m = new DOMMatrixReadOnly(getComputedStyle(el).transform); return Math.round(Math.atan2(m.b, m.a) * 180 / Math.PI); }
            function updateBox() {
                if (!current || !box) return;
                box.style.display = 'block'; const r = current.getBoundingClientRect(); const rc = canvas.getBoundingClientRect();
                const x = r.left - rc.left; const y = r.top - rc.top; box.style.width = r.width + 'px'; box.style.height = r.height + 'px'; box.style.left = x + 'px'; box.style.top = y + 'px'; box.style.transform = `rotate(${getAngle(current)}deg)`;
            }
            function makeInteractive(el) { el.addEventListener('pointerdown', (e) => { if (e.button !== 0) return; select(el); startDrag(el, e); }); }
            function startDrag(el, e) {
                e.preventDefault(); el.setPointerCapture(e.pointerId); el.classList.add('grab');
                const r = el.getBoundingClientRect(); const rc = canvas.getBoundingClientRect();
                dragState = { x: e.clientX, y: e.clientY, left: r.left - rc.left, top: r.top - rc.top, angle: getAngle(el) };
                const move = (ev) => { const dx = ev.clientX - dragState.x; const dy = ev.clientY - dragState.y; el.style.left = (dragState.left + dx) + 'px'; el.style.top = (dragState.top + dy) + 'px'; el.style.transform = `translate(0,0) rotate(${dragState.angle}deg)`; updateBox(); };
                const up = () => { el.releasePointerCapture(e.pointerId); window.removeEventListener('pointermove', move); window.removeEventListener('pointerup', up); el.classList.remove('grab'); };
                window.addEventListener('pointermove', move); window.addEventListener('pointerup', up);
            }
            function rsStart(corner) {
                return function (e) {
                    if (!current) return; e.preventDefault(); e.stopPropagation();
                    const r = current.getBoundingClientRect(); const base = { w: r.width, h: r.height }; const orig = { x: e.clientX, y: e.clientY }; const keepRatio = !e.shiftKey;
                    const sgnX = (corner === 'ne' || corner === 'se') ? 1 : -1; const sgnY = (corner === 'se' || corner === 'sw') ? 1 : -1;
                    const move = (ev) => {
                        const dx = (ev.clientX - orig.x) * sgnX; const dy = (ev.clientY - orig.y) * sgnY;
                        let nw = Math.max(24, base.w + dx); let nh = Math.max(24, base.h + dy);
                        if (keepRatio) { const ratio = Math.max(nw / base.w, nh / base.h); nw = base.w * ratio; nh = base.h * ratio; }
                        current.style.width = nw + 'px'; current.style.height = 'auto'; updateBox();
                    };
                    const up = () => { window.removeEventListener('pointermove', move); window.removeEventListener('pointerup', up); };
                    window.addEventListener('pointermove', move); window.addEventListener('pointerup', up);
                }
            }
            function rotStart(e) {
                if (!current) return; e.preventDefault(); e.stopPropagation();
                const rc = canvas.getBoundingClientRect(); const r = current.getBoundingClientRect();
                const cx = r.left - rc.left + r.width / 2; const cy = r.top - rc.top + r.height / 2;
                const move = (ev) => { const ang = Math.atan2((ev.clientY - rc.top) - cy, (ev.clientX - rc.left) - cx) * 180 / Math.PI; current.style.transform = `translate(0,0) rotate(${Math.round(ang)}deg)`; updateBox(); };
                const up = () => { window.removeEventListener('pointermove', move); window.removeEventListener('pointerup', up); };
                window.addEventListener('pointermove', move); window.addEventListener('pointerup', up);
            }
        })();
    </script>

    <!-- ìº¡ì²˜ ì €ì¥ â†’ diary.html í•´ë‹¹ ë‚ ì§œë¡œ ì´ë™ -->
    <script>
        /* ===== ìº¡ì²˜ ì €ì¥ (ê½ƒ/ì†Œí’ˆ ë³´ì´ë„ë¡) ===== */
        function markCalendarAsCaptured(dateStr) {
            const calGrid = document.getElementById('calGrid');
            if (!calGrid || !dateStr) return;

            // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ ì…€(.cell.sel)ì„ ìš°ì„  ê°±ì‹ 
            let sel = calGrid.querySelector('.cell.sel');

            // ì•ˆì „ì¥ì¹˜: ì„ íƒ ì…€ ì—†ìœ¼ë©´ í˜„ì¬ ê·¸ë¦¬ë“œì—ì„œ í•´ë‹¹ ë‚ ì§œ ì°¾ê¸°
            if (!sel) {
                const [y, m, d] = dateStr.split('-');
                // ê°™ì€ ë‹¬ì¼ ë•Œë§Œ data-dayë¡œ ì°¾ê¸° (ë³´ì—¬ì§€ëŠ” ë‹¬ì´ ë‹¤ë¥´ë©´ ë‹¤ìŒ build ë•Œ ìë™ ë°˜ì˜ë¨)
                const gridMonth = document.getElementById('ytext')?.textContent;
                const gridMName = document.getElementById('mname')?.textContent; // 'SEP' ê°™ì€ í…ìŠ¤íŠ¸
                // ê°™ì€ ë‹¬ ì—¬ë¶€ëŠ” ê°„ë‹¨íˆ ìƒëµí•˜ê³ , ì¼ì¹˜í•˜ëŠ” data-dayë§Œ ë¨¼ì € ì‹œë„
                sel = calGrid.querySelector(`.cell[data-day="${Number(d)}"]`);
            }

            if (!sel) return; // í˜„ì¬ ë³´ì´ëŠ” ë‹¬ì´ ì•„ë‹ˆë©´ ì´í›„ ìº˜ë¦°ë” ë¦¬ë¹Œë“œì‹œ ìë™ ì˜¤ë Œì§€ ì²˜ë¦¬ë¨

            let mark = sel.querySelector('.mark-flower');
            if (!mark) {
                mark = document.createElement('span');
                mark.className = 'mark-flower';
                mark.textContent = 'âœ¿';
                sel.appendChild(mark);
            }
            mark.classList.add('orange');   // ë°”ë¡œ ì˜¤ë Œì§€ ì ìš©
        }

        (function () {
            const $ = (q, r = document) => r.querySelector(q);

            async function saveCapture(dataUrl, dateStr) {
                // 1) ë‹¨ì¼ í‚¤
                localStorage.setItem(`garden_capture_${dateStr}`, dataUrl);

                // 2) ë‚ ì§œë³„ ëª©ë¡ ë§µ (diaryê°€ ì½ëŠ” í‚¤)
                const map = JSON.parse(localStorage.getItem('photos_by_date') || '{}');
                map[dateStr] = Array.isArray(map[dateStr]) ? map[dateStr] : [];
                map[dateStr].push(dataUrl);
                localStorage.setItem('photos_by_date', JSON.stringify(map));
            }

            // html2canvas ë³´ì • ì˜µì…˜
            async function takeShot(target) {
                // ì´ë¯¸ì§€ê°€ ëª¨ë‘ ë¡œë“œë˜ë„ë¡ ì ê¹ ì–‘ë³´
                await new Promise(r => setTimeout(r, 30));
                return await html2canvas(target, {
                    useCORS: true,          // ì™¸ë¶€/ìƒëŒ€ê²½ë¡œ ì´ë¯¸ì§€ í—ˆìš©
                    allowTaint: false,
                    backgroundColor: null,  // íˆ¬ëª… ë°°ê²½ ìœ ì§€
                    scale: window.devicePixelRatio > 1 ? 2 : 1,
                    logging: false
                });
            }

            document.addEventListener('click', async (e) => {
                if (e.target && e.target.id === 'btnCapture') {
                    const canvasBox = $('#canvas');
                    if (!canvasBox) { alert('ìº”ë²„ìŠ¤ê°€ ì—†ì–´ìš”.'); return; }
                    const dateStr = ($('#dateBadge')?.textContent || '').trim();
                    if (!dateStr) { alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

                    try {
                        const cvs = await takeShot(canvasBox);
                        const dataUrl = cvs.toDataURL('image/png', 0.95);
                        await saveCapture(dataUrl, dateStr);

                        // âœ… ì €ì¥ ì§í›„ ë‹¬ë ¥ ì•„ì´ì½˜ì„ ì˜¤ë Œì§€ë¡œ ì¦‰ì‹œ ê°±ì‹ 
                        markCalendarAsCaptured(dateStr);

                        // ì €ì¥ ì§í›„, ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ /ë‹¤ì´ì–´ë¦¬ ì—°ê²°(ì„ íƒ)
                        if (window.updateLastCaptureUI) updateLastCaptureUI(dateStr);
                        alert('ì •ì› ìº¡ì²˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } catch (err) {
                        console.error(err);
                        alert('ìº¡ì²˜ ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.');
                    }
                }
            });
        })();
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const editBtn = document.getElementById("editTodayBtn");
            if (editBtn) {
                editBtn.addEventListener("click", () => {
                    const date = document.getElementById("dateBadge").textContent || "";
                    if (date) {
                        // âœ… 1. ì •ì› ì—ë””í„° ë¹„ìš°ê¸°
                        const canvas = document.getElementById("canvas");
                        Array.from(canvas.querySelectorAll("img, .selbox")).forEach(el => el.remove());
                        canvas.style.backgroundImage = "none";

                        // âœ… 2. localStorage ìƒíƒœ ì œê±°
                        localStorage.removeItem(`garden_state_${date}`);
                        localStorage.removeItem(`garden_capture_${date}`);
                        try {
                            const map = JSON.parse(localStorage.getItem("photos_by_date") || "{}");
                            if (map[date]) {
                                delete map[date];
                                localStorage.setItem("photos_by_date", JSON.stringify(map));
                            }
                        } catch { }

                        // âœ… 3. ë‹¬ë ¥ í‘œì‹œ ê°±ì‹  (âœ¿ íšŒìƒ‰ìœ¼ë¡œ)
                        const calGrid = document.getElementById("calGrid");
                        const sel = calGrid?.querySelector(".cell.sel");
                        if (sel) {
                            const mark = sel.querySelector(".mark-flower");
                            if (mark) mark.classList.remove("orange");
                        }

                        // âœ… 4. today.htmlë¡œ ì´ë™ (ë‚ ì§œ íŒŒë¼ë¯¸í„° ì „ë‹¬)
                        location.href = `today.html?date=${encodeURIComponent(date)}`;
                    } else {
                        alert("ìˆ˜ì •í•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                    }
                });
            }
        });

    </script>
    <script>
        /* ==== (A) ë„ìš°ë¯¸ & ê¸°ë¡ êµ¬ì¡°í™”: diary.html ë¡œì§ ì´ì‹ ==== */
        const asArray = v => Array.isArray(v) ? v : (v == null ? [] : [v]);
        const mergeU = (a, b) => Array.from(new Set([...(a || []), ...(b || [])]));
        const normalize = (x) => {
            if (!x) return '';
            const m = String(x).trim().match(/(\d{4})[./-](\d{1,2})[./-](\d{1,2})/);
            return m ? `${m[1]}-${String(m[2]).padStart(2, '0')}-${String(m[3]).padStart(2, '0')}` : '';
        };

        function getDayStructured(dateStr) {
            const out = { oneLine: '', feeling: '', keywords: [], flowers: [], props: [], weather: [] };
            const keys = ['moodiary_today', 'today_data', 'today', 'moodiary_session']; // today.htmlì´ ì“°ëŠ” ì €ì¥ì†Œ ìš°ì„  í™•ì¸
            for (const k of keys) {
                try {
                    const raw = localStorage.getItem(k);
                    if (!raw) continue;
                    const v = JSON.parse(raw);

                    // ê°ì²´í˜• ì €ì¥
                    if (v && !Array.isArray(v)) {
                        const data = v[dateStr] || v[dateStr.replace(/-/g, '.')] || v[dateStr.replace(/-/g, '/')] || null;
                        if (data) {
                            out.feeling = out.feeling || (data.feeling || data.emotion || '');
                            out.keywords = mergeU(out.keywords, asArray(data.keywords || data.tags).filter(Boolean));
                            out.flowers = mergeU(out.flowers,
                                asArray(data.flowers || data.flowerCards || data.selected)
                                    .map(f => typeof f === 'string' ? f : (f?.name || f?.title || 'ê½ƒ'))
                                    .filter(Boolean)
                            );
                            out.props = mergeU(out.props,
                                asArray(data.props || data.items || data.accessories)
                                    .map(x => typeof x === 'string' ? x : (x?.name || x?.title || 'ì†Œí’ˆ'))
                                    .filter(Boolean)
                            );
                            if (data.weather) out.weather = mergeU(out.weather, [typeof data.weather === 'string' ? data.weather : (data.weather.slug || data.weather)]);
                            out.oneLine = out.oneLine || String(data.oneLine || data.text || '').trim();
                        }
                    }

                    // ë°°ì—´í˜• ì €ì¥
                    if (Array.isArray(v)) {
                        v.forEach(it => {
                            const nd = normalize(it?.date || it?.createdAt || it?.updatedAt);
                            if (nd !== dateStr) return;
                            out.feeling = out.feeling || (it.emotion || it.feeling || '');
                            out.keywords = mergeU(out.keywords, asArray(it.keywords || it.tags).filter(Boolean));
                            out.flowers = mergeU(out.flowers,
                                asArray(it.flowers || it.flowerCards || it.selected)
                                    .map(f => typeof f === 'string' ? f : (f?.name || f?.title || 'ê½ƒ'))
                                    .filter(Boolean)
                            );
                            out.props = mergeU(out.props,
                                asArray(it.props || it.items || it.accessories)
                                    .map(x => typeof x === 'string' ? x : (x?.name || x?.title || 'ì†Œí’ˆ'))
                                    .filter(Boolean)
                            );
                            if (it.weather) out.weather = mergeU(out.weather, [typeof it.weather === 'string' ? it.weather : (it.weather.slug || it.weather)]);
                            if (it.text || it.oneLine || it.title) out.oneLine = out.oneLine || String(it.text || it.oneLine || it.title).trim();
                        });
                    }
                } catch { }
            }

            // í•œì¤„ ê¸°ë¡ íˆìŠ¤í† ë¦¬(ì˜µì…˜): ê°€ì¥ ìµœê·¼ í…ìŠ¤íŠ¸ë¡œ ë³´ê°•
            try {
                const std = JSON.parse(localStorage.getItem('moodiary_oneline_history') || 'null');
                if (Array.isArray(std)) {
                    const same = std.filter(v => normalize(v?.date) === dateStr && v?.text);
                    if (same.length) out.oneLine = String(same[same.length - 1].text).trim();
                }
            } catch { }

            // ğŸ’¡ diary.htmlê³¼ ë™ì¼ ë³´ì • ê·œì¹™
            if ((!out.keywords || out.keywords.length === 0) && out.feeling) out.keywords = [out.feeling];
            if (!out.oneLine && out.feeling) out.oneLine = out.feeling;

            return out;
        }

        /* ê½ƒ/ì†Œí’ˆ ì¹© ì•„ì´ì½˜ â€“ diary.htmlê³¼ ë™ì¼ ê²½ë¡œ ìš°ì„ ìˆœìœ„ */
        function iconImg(paths, alt, emoji) {
            const box = document.createElement('span');
            const img = document.createElement('img');
            img.className = 'icon'; img.alt = alt || '';
            if (!Array.isArray(paths)) paths = [paths];
            let i = 0;
            const tryNext = () => {
                if (i >= paths.length) { box.textContent = emoji || 'âœ¿'; return; }
                img.src = paths[i++]; img.onerror = tryNext;
            };
            tryNext(); box.appendChild(img); return box;
        }
        const FLOWERS = [
            { image: 'img/flowers/hydrangea.svg', text: 'Hydrangea' },
            { image: 'img/flowers/babybreath.svg', text: "Babyâ€™s Breath" },
            { image: 'img/flowers/lavender.svg', text: 'Lavender' },
            { image: 'img/flowers/freesia.svg', text: 'Freesia' },
            { image: 'img/flowers/daisy.svg', text: 'Daisy' },
            { image: 'img/flowers/white-lily.svg', text: 'White Lily' },
            { image: 'img/flowers/lilac.svg', text: 'Lilac' },
            { image: 'img/flowers/white-tulip.svg', text: 'White Tulip' },
            { image: 'img/flowers/sunflower.svg', text: 'Sunflower' },
            { image: 'img/flowers/peony.svg', text: 'Peony' },
            { image: 'img/flowers/forgetmenot.svg', text: 'Forget-me-not' },
            { image: 'img/flowers/lotus.svg', text: 'Lotus' }
        ];
        const propEmojiMap = { star: 'âœ¨', butterfly: 'ğŸ¦‹', rain: 'ğŸŒ§ï¸', cloud: 'â˜ï¸', fence: 'ğŸªµ', grass: 'ğŸŒ¿' };
        function propIcon(name) {
            const key = String(name || '').trim().toLowerCase();
            const slug = key.replace(/\s+/g, '-');
            const c = [`img/prop-icons/${slug}.svg`, `img/sp/${slug}.svg`];
            return iconImg(c, name, propEmojiMap[key] || 'âœ¨');
        }

        /* ì¹© ë Œë” */
        function mountChips(el, arr, type) {
            el.innerHTML = '';
            if (!arr || !arr.length) { el.textContent = 'â€”'; return; }
            arr.slice(0, 24).forEach(t => {
                const chip = document.createElement('span'); chip.className = 'chip';
                if (type === 'flower') {
                    const f = FLOWERS.find(f => f.text === String(t));
                    if (f) { const img = document.createElement('img'); img.src = f.image; img.alt = f.text; img.className = 'icon'; chip.appendChild(img); }
                    chip.appendChild(document.createTextNode(String(t)));
                } else if (type === 'weather') {
                    const slug = String(t);
                    chip.appendChild(weatherIcon(slug));
                    chip.appendChild(document.createTextNode(WEATHER_LABEL[slug] || slug));
                } else if (type === 'prop') {
                    chip.appendChild(propIcon(String(t)));
                    chip.appendChild(document.createTextNode(String(t)));
                } else {
                    chip.textContent = String(t);
                }
                el.appendChild(chip);
            });
        }


        /* ==== (B) í•˜ë‹¨ ìš”ì•½ ë Œë” ==== */
        function renderMiniDetails(dateStr) {
            const data = getDayStructured(dateStr);
            const $id = (x) => document.getElementById(x);

            $id('mdOneLine').textContent = data.oneLine || 'â€”';
            mountChips($id('mdKeywords'), data.keywords, 'tag');
            mountChips($id('mdFlowers'), data.flowers, 'flower');

            const weatherArr = (data.weather && data.weather.length) ? data.weather : []; // today ì €ì¥ì€ slug 1ê°œ
            if (weatherArr.length) {
                mountChips($id('mdWeather'), weatherArr, 'weather');
            } else {
                // êµ¬í˜• propsê°€ ìˆë‹¤ë©´ ì„ì‹œë¡œ ë³´ì—¬ì£¼ê¸° (í˜¸í™˜)
                mountChips($id('mdWeather'), data.props, 'prop');
            }
        }

        /* ==== (C) ë‹¬ë ¥ ì´ë²¤íŠ¸ì— ì—°ê²°: ë‚ ì§œ ì„ íƒ/ì›” ì´ë™ ì‹œ ê°±ì‹  ==== */
        (function hookMiniDetails() {
            // ì´ˆê¸° ì„ íƒ ë‚ ì§œ = day.htmlì´ ì‚¬ìš©í•˜ëŠ” selDate / dateBadgeë¥¼ ì°¸ê³ 
            const badge = document.getElementById('dateBadge');
            const initial = (badge?.textContent || '').trim();
            if (initial) renderMiniDetails(initial);

            // ì „ì—­ loadForDateëŠ” ì´ë¯¸ day.htmlì—ì„œ ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ê·¸ ë’¤ì— í›„í‚¹
            const _loadForDate = window.loadForDate;
            window.loadForDate = function (dateStr) {
                if (_loadForDate) _loadForDate(dateStr);
                renderMiniDetails(dateStr);     // â¬…ï¸ ë‚ ì§œ ë°”ë€” ë•Œ í•˜ë‹¨ ìš”ì•½ ë™ê¸°í™”
            };

            // ì›” ì´ë™ ë²„íŠ¼(ì˜¤ëŠ˜/ì´ì „/ë‹¤ìŒ) í´ë¦­ í›„ì—ë„ ì„ íƒ ì…€ì„ ê¸°ì¤€ìœ¼ë¡œ ë™ê¸°í™”
            ['prevM', 'todayM', 'nextM'].forEach(id => {
                const b = document.getElementById(id);
                if (!b) return;
                b.addEventListener('click', () => {
                    // ë²„íŠ¼ ì²˜ë¦¬ í›„ ì•½ê°„ ëŠ¦ê²Œ í˜„ì¬ badge ê¸°ì¤€ìœ¼ë¡œ ë°˜ì˜
                    setTimeout(() => {
                        const ds = (document.getElementById('dateBadge')?.textContent || '').trim();
                        if (ds) renderMiniDetails(ds);
                    }, 0);
                });
            });
        })();
    </script>
    <script>
        // ë‚ ì”¨ ë¼ë²¨/ì•„ì´ì½˜ (diary.htmlê³¼ ë™ì¼ ì»¨ë²¤ì…˜)
        const WEATHER_LABEL = { sun: 'í–‡ë¹›', rain: 'ë¹„', lightning: 'ë²ˆê°œ', snow: 'ëˆˆ' };
        const weatherEmoji = { sun: 'â˜€ï¸', rain: 'ğŸŒ§ï¸', lightning: 'âš¡', snow: 'â„ï¸' };

        function weatherIcon(slug) {
            const box = document.createElement('span');
            const img = document.createElement('img');
            img.className = 'icon';
            img.alt = WEATHER_LABEL[slug] || 'ë‚ ì”¨';
            let tried = false;
            img.onerror = () => { if (!tried) { tried = true; box.textContent = weatherEmoji[slug] || 'â˜€ï¸'; } };
            img.src = `img/weather/${slug}.svg`;
            box.appendChild(img);
            return box;
        }
    </script>

    <script>
        /* ===== URL â†’ DataURL ë³€í™˜ ===== */
        async function urlToDataURL(url) {
            const res = await fetch(url, { mode: 'cors' });
            const blob = await res.blob();
            return await new Promise((resv) => {
                const fr = new FileReader();
                fr.onload = () => resv(fr.result);
                fr.readAsDataURL(blob);
            });
        }

        /* ===== ê½ƒ/ì†Œí’ˆ ìŠ¤í”„ë¼ì´íŠ¸ ì¶”ê°€ =====
           - src: 'img/flowers/daisy.svg'ì²˜ëŸ¼ ìƒëŒ€ê²½ë¡œ
           - type: 'flower' | 'prop' | 'bg'
        */
        async function addSpriteFromURL(type, src) {
            try {
                const dataUrl = await urlToDataURL(src);
                const box = document.getElementById('canvas');
                if (!box) return;

                // ë°°ê²½ì€ background-imageë¡œ, ë‚˜ë¨¸ì§€ëŠ” <img>ë¡œ
                if (type === 'bg') {
                    box.style.backgroundImage = `url('${dataUrl}')`;
                    box.style.backgroundSize = 'cover';
                    box.style.backgroundPosition = 'center';
                    return;
                }

                const el = document.createElement('img');
                el.className = `dr ${type}`;
                el.draggable = false;
                el.alt = type;
                el.src = dataUrl;                 // â† DataURL ì ìš© (CORS íšŒí”¼)
                el.style.position = 'absolute';
                el.style.left = '50%';
                el.style.top = '50%';
                el.style.transform = 'translate(-50%,-50%)';
                el.style.width = '160px';
                el.style.userSelect = 'none';
                box.appendChild(el);

                // (ì„ íƒ) ê¸°ì¡´ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ/íšŒì „ íˆ´ê³¼ ì—°ë™
                if (window.attachEditorHandles) window.attachEditorHandles(el);
            } catch (e) {
                console.warn('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨', e);
                alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.');
            }
        }

        /* ===== ì¸ë„¤ì¼ í´ë¦­ ë°”ì¸ë”© ì˜ˆì‹œ =====
           - ê¸°ì¡´ì— assetsë¥¼ ë Œë”ë§í•˜ëŠ” ì½”ë“œê°€ ìˆë‹¤ë©´,
             onClickì—ì„œ addSpriteFromURLì„ í˜¸ì¶œí•˜ë„ë¡ ë°”ê¿”ì£¼ì„¸ìš”.
        */
        document.addEventListener('click', (e) => {
            const t = e.target.closest('[data-asset-type][data-src]');
            if (!t) return;
            const type = t.getAttribute('data-asset-type');
            const src = t.getAttribute('data-src');
            addSpriteFromURL(type, src);
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById("canvas");

            function restoreCapture(dateStr) {
                if (!dateStr || !canvas) return;

                // 1) ê°œë³„ í‚¤
                let capture = localStorage.getItem(`garden_capture_${dateStr}`);

                // 2) photos_by_date ë§µ
                if (!capture) {
                    try {
                        const map = JSON.parse(localStorage.getItem("photos_by_date") || "{}");
                        if (map[dateStr] && map[dateStr].length) {
                            capture = map[dateStr][map[dateStr].length - 1];
                        }
                    } catch { }
                }

                // 3) ì ìš©/ì´ˆê¸°í™”
                if (capture && capture.startsWith("data:image")) {
                    canvas.style.backgroundImage = `url(${capture})`;
                    canvas.style.backgroundSize = "cover";
                    canvas.style.backgroundPosition = "center";
                } else {
                    // âœ… ì´ ë¶€ë¶„ì´ í•µì‹¬: í•´ë‹¹ ë‚ ì§œ ì‚¬ì§„ì´ ì—†ìœ¼ë©´ ë°˜ë“œì‹œ ì§€ì›€
                    canvas.style.backgroundImage = "none";
                }
            }

            // ì´ˆê¸° ë¡œë“œ
            const params = new URL(location.href).searchParams;
            const initial = params.get("date") || DataBridge.bestDate();
            restoreCapture(initial);

            // ë‚ ì§œ ë°”ë€” ë•Œë§ˆë‹¤ ê°±ì‹ 
            window.loadForDate = (function (orig) {
                return function (dateStr) {
                    orig(dateStr);      // ê¸°ì¡´ ì¹´ë“œ/í…ìŠ¤íŠ¸ ë¡œë“œ
                    restoreCapture(dateStr); // âœ… ì •ì›ì‚¬ì§„ ê°±ì‹ 

                    updateMemoUI(dateStr);
                };
            })(window.loadForDate);
        });
    </script>

    <script>
        (function () {
            const canvas = document.getElementById('canvas');
            let currentDate =
                (new URL(location.href)).searchParams.get('date') ||
                (window.DataBridge && DataBridge.bestDate && DataBridge.bestDate()) || '';

            const STATE_KEY = (date) => `garden_state_${date}`;

            function parseTransform(tx) {
                const out = { rotate: 0, scale: 1 };
                if (!tx) return out;
                const rot = tx.match(/rotate\(([-\d.]+)deg\)/);
                const sc = tx.match(/scale\(([-\d.]+)\)/);
                if (rot) out.rotate = parseFloat(rot[1]) || 0;
                if (sc) out.scale = parseFloat(sc[1]) || 1;
                return out;
            }

            function serializeEl(el) {
                const rect = el.getBoundingClientRect();
                const parentRect = canvas.getBoundingClientRect();
                const style = getComputedStyle(el);
                const { rotate, scale } = parseTransform(style.transform);
                const x = ((rect.left - parentRect.left) / parentRect.width) * 100;
                const y = ((rect.top - parentRect.top) / parentRect.height) * 100;
                const w = (rect.width / parentRect.width) * 100;
                const h = (rect.height / parentRect.height) * 100;
                const src = (el.getAttribute('src') || '').toString();
                let type = 'item';
                if (src.includes('/flowers/')) type = 'flower';
                else if (src.includes('/sp/') || src.includes('/prop') || src.includes('/props/')) type = 'prop';
                return {
                    tag: 'img', type, src, x, y, w, h, rotate, scale,
                    z: parseInt(style.zIndex || el.style.zIndex || 0, 10) || 0
                };
            }

            function saveCanvasState(date) {
                if (!date || !canvas) return;
                const items = Array.from(canvas.querySelectorAll('img')).map(serializeEl);
                localStorage.setItem(STATE_KEY(date), JSON.stringify({ items }));
            }

            function restoreCanvasState(date) {
                if (!date || !canvas) return;
                const raw = localStorage.getItem(STATE_KEY(date));
                // ë°°ê²½ì€ ìº¡ì²˜/ë°°ê²½ ë³µì› ë¡œì§ì—ì„œ ë”°ë¡œ ì²˜ë¦¬ â†’ ì˜¤ë¸Œì íŠ¸ë§Œ ì •ë¦¬
                Array.from(canvas.children).forEach(ch => { if (ch.tagName === 'IMG') ch.remove(); });
                if (!raw) return;
                try {
                    const { items } = JSON.parse(raw) || {};
                    if (!Array.isArray(items)) return;
                    items.forEach(it => {
                        if (it.tag !== 'img' || !it.src) return;
                        const img = document.createElement('img');
                        img.src = it.src; img.alt = it.type || 'item';
                        img.style.position = 'absolute';
                        img.style.left = `${it.x}%`; img.style.top = `${it.y}%`;
                        img.style.width = `${it.w}%`; img.style.height = `${it.h}%`;
                        img.style.objectFit = 'contain';
                        img.style.transform = `rotate(${it.rotate || 0}deg) scale(${it.scale || 1})`;
                        img.style.zIndex = String(it.z || 0);
                        canvas.appendChild(img);
                    });
                } catch { }
            }

            // ì´ˆê¸° ë³µì›
            restoreCanvasState(currentDate);

            // ë‚ ì§œê°€ ë°”ë€” ë•Œë§ˆë‹¤: currentDate ì—…ë°ì´íŠ¸ + ë³µì›
            if (window.loadForDate) {
                const origLoad = window.loadForDate;
                window.loadForDate = function (dateStr) {
                    currentDate = dateStr;          // âœ… ìµœì‹  ë‚ ì§œë¡œ ê°±ì‹ 
                    origLoad(dateStr);
                    restoreCanvasState(dateStr);    // âœ… ì˜¤ë¸Œì íŠ¸ ë³µì›
                };
            }

            // ìë™ ì €ì¥: DOM ë³€ê²½/ì¡°ì‘ ì¢…ë£Œ ì‹œ
            function debounce(fn, ms = 250) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
            const debouncedSave = debounce(() => saveCanvasState(currentDate), 250);

            const mo = new MutationObserver(() => debouncedSave());
            mo.observe(canvas, { childList: true, subtree: true, attributes: true, attributeFilter: ['style', 'src'] });
            ['pointerup', 'mouseup', 'touchend'].forEach(ev => canvas.addEventListener(ev, () => debouncedSave(), { passive: true }));

            // ìº¡ì²˜ ë²„íŠ¼ ëˆŒëŸ¬ ì €ì¥í•  ë•Œë„ í•¨ê»˜ ì €ì¥
            document.getElementById('btnCapture')?.addEventListener('click', () => saveCanvasState(currentDate));
        })();
    </script>
    <script>
        /* === ìƒˆ ì˜¤ëŠ˜ê¸°ë¡ì´ ì €ì¥ëœ ë‚ ì§œëŠ”, ìº”ë²„ìŠ¤ë¥¼ â€˜ê¹¨ë—í•˜ê²Œâ€™ ì´ˆê¸°í™” === */

        /** ë‚ ì§œë³„ fresh-flag í‚¤ */
        const FRESH_KEY = (date) => `moodiary_fresh_${date}`;

        /** ë‚ ì§œë³„ ìƒíƒœ/ì´ë¯¸ì§€ í‚¤ */
        const CAPTURE_KEY = (date) => `garden_capture_${date}`;
        const STATE_KEY = (date) => `garden_state_${date}`;

        /** ì •ì› ì—ë””í„°/ì‚¬ì§„ì„ ì™„ì „ ì´ˆê¸°í™” */
        function resetGardenFor(dateStr) {
            const canvas = document.getElementById('canvas');
            if (!dateStr || !canvas) return;

            // 1) ì—ë””í„° ì˜¤ë¸Œì íŠ¸ ì œê±°
            Array.from(canvas.children).forEach(ch => { if (ch.tagName === 'IMG') ch.remove(); });

            // 2) ë°°ê²½ ì´ˆê¸°í™”
            canvas.style.backgroundImage = 'none';

            // 3) ì €ì¥ë¬¼ ì‚­ì œ: ìº¡ì²˜Â·ìƒíƒœÂ·ë§µ
            localStorage.removeItem(CAPTURE_KEY(dateStr));     // ë‹¨ì¼ ìº¡ì²˜
            localStorage.removeItem(STATE_KEY(dateStr));       // ì˜¤ë¸Œì íŠ¸ ìƒíƒœ

            try {
                const map = JSON.parse(localStorage.getItem('photos_by_date') || '{}');
                if (map[dateStr]) {
                    delete map[dateStr];
                    localStorage.setItem('photos_by_date', JSON.stringify(map));
                }
            } catch { }
        }
        // ì˜¤ëŠ˜ê¸°ë¡ ì €ì¥ì´ ì„±ê³µí•œ ì§í›„:
        localStorage.setItem(`moodiary_reset_diary_${dateStr}`, '1');     // ì´ˆê¸°í™” í”Œë˜ê·¸
        location.href = `diary.html?date=${encodeURIComponent(dateStr)}&reset=1`;


        /** fresh í”Œë˜ê·¸ë¥¼ ì²´í¬í•´, ìˆìœ¼ë©´ ì´ˆê¸°í™”í•˜ê³  í”Œë˜ê·¸ë¥¼ ì§€ì›€ */
        function checkFreshAndMaybeReset(dateStr) {
            const k = FRESH_KEY(dateStr);
            if (localStorage.getItem(k) === '1') {
                resetGardenFor(dateStr);
                localStorage.removeItem(k);
            }
        }

        /* ì´ˆê¸° ì§„ì… ì‹œì  */
        document.addEventListener('DOMContentLoaded', () => {
            const badge = document.getElementById('dateBadge');
            const initialDate = (badge?.textContent || '').trim() ||
                (window.DataBridge && DataBridge.bestDate && DataBridge.bestDate()) || '';
            if (initialDate) checkFreshAndMaybeReset(initialDate);
        });

        /* ë‚ ì§œê°€ ë°”ë€” ë•Œë„ ì²´í¬: ê¸°ì¡´ loadForDateë¥¼ ë˜í•‘ */
        (function hookLoadForDate() {
            if (!window.loadForDate) return;
            const orig = window.loadForDate;
            window.loadForDate = function (dateStr) {
                // 1) ìƒˆ ì˜¤ëŠ˜ê¸°ë¡ í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™”
                checkFreshAndMaybeReset(dateStr);

                // 2) ì›ë˜ ë¡œì§ ì‹¤í–‰ (ì¹´ë“œ/ìš”ì•½ ë Œë” ë“±)
                orig(dateStr);

                // 3) ì´í›„ restoreCapture/restoreCanvasStateê°€ ì‹¤í–‰ë˜ë©´ì„œ
                //    ë¹„ì›Œì§„ ìƒíƒœë¡œ ì‹œì‘ â†’ ì‚¬ìš©ìëŠ” ìƒˆ ìº”ë²„ìŠ¤ ê¾¸ë°€ ìˆ˜ ìˆìŒ
                setCanvasFromCapture(dateStr);
            };
        })();
        localStorage.setItem(`moodiary_fresh_${dateStr}`, '1');

    </script>
    <script>
        /* ë‹¤ì´ì–´ë¦¬ ì…ì¥ ì‹œ ì´ˆê¸°í™” í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œ ì •ì›ì‚¬ì§„/ìƒíƒœ ì‚­ì œ */
        (function resetDiaryIfRequested() {
            const nz = n => String(n).padStart(2, '0');
            const fmt = d => `${d.getFullYear()}-${nz(d.getMonth() + 1)}-${nz(d.getDate())}`;

            const url = new URL(location.href);
            const p = url.searchParams;

            // date íŒŒë¼ë¯¸í„° ì—†ìœ¼ë©´ ì˜¤ëŠ˜(ë˜ëŠ” ë‚´ë¶€ bestDate ë¡œì§ì„ ì“°ê³  ìˆë‹¤ë©´ ê·¸ ê°’ì„ ì‚¬ìš©)
            let dateStr = p.get('date');
            if (!dateStr) {
                const t = new Date();
                dateStr = fmt(t);
            }

            const flagKey = `moodiary_reset_diary_${dateStr}`;
            const shouldReset = p.get('reset') === '1' || localStorage.getItem(flagKey) === '1';
            if (!shouldReset) return;

            // 1) ë‹¨ì¼ ìº¡ì²˜ í‚¤ ì œê±°
            localStorage.removeItem(`garden_capture_${dateStr}`);

            // 2) ë‚ ì§œë³„ ìº¡ì²˜ ë§µì—ì„œ ì œê±°
            try {
                const map = JSON.parse(localStorage.getItem('photos_by_date') || '{}');
                if (map[dateStr]) {
                    delete map[dateStr];
                    localStorage.setItem('photos_by_date', JSON.stringify(map));
                }
            } catch { }

            // 3) (ì„ íƒ) ì—ë””í„° ìƒíƒœë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ê°™ì´ ì œê±°
            localStorage.removeItem(`garden_state_${dateStr}`);

            // 4) í”Œë˜ê·¸ ì†Œëª¨
            localStorage.removeItem(flagKey);
        })();
    </script>
    <script>
        (function addClouds() {
            const container = document.getElementById("backgroundDecor");
            const cloudImgs = [
                "img/sp/cloud1.svg",
                "img/sp/cloud2.svg",
                "img/sp/cloud3.svg",
                "img/sp/cloud4.svg"
            ];

            for (let i = 0; i < 8; i++) { // êµ¬ë¦„ ê°œìˆ˜ (ì¡°ê¸ˆ ëŠ˜ë¦¼)
                const img = document.createElement("img");
                img.src = cloudImgs[Math.floor(Math.random() * cloudImgs.length)];
                img.className = "cloud";

                // í¬ê¸° (ë” í¬ê²Œ: 180~320px ëœë¤)
                const size = 180 + Math.random() * 140;
                img.style.width = size + "px";

                // ì‹œì‘ ë†’ì´ (0~70%)
                img.style.top = Math.random() * 70 + "%";

                // ì‹œì‘ ìœ„ì¹˜ (ì™¼ìª½ í™”ë©´ ë°–)
                img.style.left = (-300 - Math.random() * 200) + "px";

                // ì• ë‹ˆë©”ì´ì…˜ ì†ë„ (20~40ì´ˆ ëœë¤)
                const duration = 20 + Math.random() * 20;
                img.style.animationDuration = duration + "s";

                // ì‚´ì§ ëœë¤ ë”œë ˆì´ â†’ ê²¹ì¹˜ì§€ ì•Šê³  ìì—°ìŠ¤ëŸ½ê²Œ
                img.style.animationDelay = (-Math.random() * duration) + "s";

                container.appendChild(img);
            }
        })();
    </script>
    <script>
        (function DiaryEmbedInit() {
            // day.htmlì— ì´ë¯¸ ìˆëŠ” ìœ í‹¸ê³¼ DataBridgeë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const z = n => String(n).padStart(2, '0');
            const fmt = d => `${d.getFullYear()}-${z(d.getMonth() + 1)}-${z(d.getDate())}`;
            const MONTHS_EN = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            const $ = (q, r = document) => r.querySelector(q);
            const $$ = (q, r = document) => Array.from(r.querySelectorAll(q));

            const grid = $('#de_grid');
            const mNum = $('#de_monthNum');
            const mName = $('#de_monthName');
            const yText = $('#de_yearText');
            const rangeT = $('#de_rangeText');
            const prev = $('#de_prev');
            const next = $('#de_next');
            const todayB = $('#de_todayBtn');

            let todayISO = fmt(new Date());
            let cur = new Date(todayISO);

            function markInfoFor(dateStr) {
                const d = (window.DataBridge && DataBridge.readAny) ? DataBridge.readAny(dateStr) : null;
                if (!d) return { hasRecord: false, hasCapture: false };
                const hasRecord = !!(d.quote || d.flower || (d.props && d.props.length));
                const hasCapture = !!d.capture;
                return { hasRecord, hasCapture };
            }

            function build(d) {
                grid.innerHTML = '';
                const y = d.getFullYear(), m = d.getMonth();
                mNum.textContent = z(m + 1);
                mName.textContent = MONTHS_EN[m];
                yText.textContent = y;

                const first = new Date(y, m, 1);
                const start = first.getDay();
                const last = new Date(y, m + 1, 0).getDate();

                for (let i = 0; i < start; i++) {
                    const div = document.createElement('div');
                    div.className = 'cell off';
                    grid.appendChild(div);
                }

                for (let day = 1; day <= last; day++) {
                    const dateStr = `${y}-${z(m + 1)}-${z(day)}`;
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (dateStr === todayISO) cell.classList.add('today');

                    // ë‚ ì§œ ìˆ«ì
                    const btn = document.createElement('button');
                    btn.className = 'date-number';
                    btn.type = 'button';
                    btn.textContent = String(day);
                    btn.addEventListener('click', () => goToDay(dateStr));
                    cell.appendChild(btn);

                    // í‘œì‹œ(ê½ƒ/ì‚¬ì§„)
                    const { hasRecord, hasCapture } = markInfoFor(dateStr);
                    if (hasRecord) {
                        const box = document.createElement('div');
                        box.className = 'thumb-box' + (hasCapture ? '' : '');
                        if (hasCapture) {
                            // ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì‘ì€ í”Œë¼ì›Œ ì´ëª¨ì§€
                            box.textContent = 'âœ¿';
                        }
                        cell.appendChild(box);
                    }

                    grid.appendChild(cell);
                }

                rangeT.textContent = `${y}-${z(m + 1)}  (${z(1)} ~ ${z(last)})`;
            }

            function goToDay(dateStr) {
                try {
                    // âœ… ì„¸ì…˜2 ë¯¸ë‹ˆ ë‹¬ë ¥ ì›”/ì„ íƒê¹Œì§€ ì¦‰ì‹œ ë°˜ì˜
                    if (typeof showOnMiniCalendar === 'function') { showOnMiniCalendar(dateStr); }

                    // âœ… ì¹´ë“œ/ì˜µì…˜/í—¤ë“œë¼ì¸ë„ í•´ë‹¹ ë‚ ì§œë¡œ ë™ê¸°í™”
                    if (typeof loadForDate === 'function') { loadForDate(dateStr); }
                } catch (e) { console.warn(e); }

                // âœ… ë§ˆì§€ë§‰ìœ¼ë¡œ ì„¸ì…˜2ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
                const sec = document.getElementById('snap-day');
                sec?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }


            prev.addEventListener('click', () => { cur.setMonth(cur.getMonth() - 1); build(cur); });
            next.addEventListener('click', () => { cur.setMonth(cur.getMonth() + 1); build(cur); });
            todayB.addEventListener('click', () => { cur = new Date(); build(cur); });

            build(cur);
        })();
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (location.hash === "#snap-diary") {
                const session1 = document.getElementById("snap-diary");
                const session2 = document.getElementById("snap-day");

                // ì„¸ì…˜1 ë¨¼ì € ë³´ì´ê¸°
                session1.scrollIntoView({ behavior: "instant", block: "start" });

                // 1ì´ˆ ë’¤ ì„¸ì…˜2ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
                setTimeout(() => {
                    session2.scrollIntoView({ behavior: "smooth", block: "start" });
                }, 1000);
            }
        });
    </script>
    <script>
        (() => {
            // ì•ˆì „í•˜ê²Œ í•œ ë²ˆë§Œ ë¶™ì´ê¸°
            const grid = document.getElementById('de_grid');
            if (!grid || grid.__moodiaryBound) return;
            grid.__moodiaryBound = true;

            const z = n => String(n).padStart(2, '0');

            grid.addEventListener('click', (e) => {
                // ì¹¸ ì „ì²´ ì–´ë””ë¥¼ ëˆŒëŸ¬ë„ .cellì„ ì°¾ë„ë¡ ìœ„ì„
                const cell = e.target.closest('.cell');
                if (!cell || cell.classList.contains('off')) return;

                // day ì¶”ì¶œ: ìš°ì„  data-day, ì—†ìœ¼ë©´ ìˆ«ì spanì—ì„œ í…ìŠ¤íŠ¸
                const day = cell.dataset.day
                    || (cell.querySelector('.date-number')?.textContent || '').trim();
                if (!day) return;

                // year / month ì¶”ì¶œ: ì„¸ì…˜1 í—¤ë”ì—ì„œ ì½ê¸°
                const yEl = document.getElementById('de_yearText');   // ì˜ˆ: 2025
                const mNumEl = document.getElementById('de_monthNum'); // ì˜ˆ: 08
                const year = (yEl?.textContent || '').trim();
                let month = (mNumEl?.textContent || '').trim();

                // monthê°€ 1~12 ê°™ì€ ìˆ«ìë¼ë©´ zero-pad, ì•„ë‹ˆë¼ë©´ ê·¸ëŒ€ë¡œ ì‹œë„
                if (/^\d{1,2}$/.test(month)) month = z(month);

                const dateStr = `${year}-${month}-${z(day)}`;

                // âœ… ì„¸ì…˜2ë¡œ ë‚ ì§œ ë™ê¸°í™”
                try {
                    if (typeof showOnMiniCalendar === 'function') showOnMiniCalendar(dateStr);
                    if (typeof loadForDate === 'function') loadForDate(dateStr);
                    if (typeof refreshOptions === 'function') refreshOptions();
                    if (typeof syncHeadline === 'function') syncHeadline(dateStr);
                } catch (err) { console.warn('ì„¸ì…˜2 ë™ê¸°í™” ì˜¤ë¥˜', err); }

                // âœ… ì„¸ì…˜2ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
                document.getElementById('snap-day')
                    ?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        })();
    </script>


    <script>
        /** í—¤ë”ì—¬ë°± ì œì–´: ê¸°ë³¸/í´ë¦­ëª¨ë“œ ì „í™˜ */
        (function () {
            const BASE = 'var(--header-h)';
            const EXTRA = 'calc(var(--header-h) + 20px)'; // ì—¬ë°± ëŠ˜ë¦¬ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸° ìˆ«ìë§Œ ì¡°ì ˆ

            function setSnapMargins(mode) {
                const val = (mode === 'clicked') ? EXTRA : BASE;
                // ë‘ ì„¹ì…˜ ëª¨ë‘ ì ìš©
                ['#snap-diary', '#snap-day'].forEach(id => {
                    const el = document.querySelector(id);
                    if (el) el.style.scrollMarginTop = val;
                });
                // ìŠ¤ëƒ… ì»¨í…Œì´ë„ˆ scroll-padding-topë„ ë™ì¼í•˜ê²Œ ë³´ì •(ìŠ¤ëƒ… ê¸°ì¤€ì  ì¼ì¹˜)
                const vp = document.querySelector('.snap-viewport');
                if (vp) vp.style.scrollPaddingTop = val;
            }

            // 1) í˜ì´ì§€ë¥¼ ì§ì ‘ ì—´ì—ˆì„ ë•Œ(ì¼ë°˜ ì§„ì…) â†’ ê¸°ë³¸ ì—¬ë°± ìœ ì§€
            document.addEventListener('DOMContentLoaded', () => setSnapMargins('default'));

            // 2) ë‹¬ë ¥ì¹¸(.cell) í´ë¦­ ì‹œë§Œ â†’ ì—¬ë°±ì„ ì¶”ê°€í•´ì„œ ë³´ì´ê²Œ
            //    ì„¸ì…˜1(#de_grid) Â· ì„¸ì…˜2(#calGrid) ë‘˜ ë‹¤ ìœ„ì„ ì²˜ë¦¬
            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.cell');
                if (!cell) return;

                // ë‹¬ë ¥ ê·¸ë¦¬ë“œ ë‚´ë¶€ í´ë¦­ì¸ì§€ í™•ì¸ (ì„¸ì…˜1/ì„¸ì…˜2 ëª¨ë‘ ëŒ€ì‘)
                const inCalendar = cell.closest('#de_grid, #calGrid');
                if (!inCalendar) return;

                // ë‹¬ë ¥ì¹¸ í´ë¦­ â†’ ì—¬ë°± ê°•í™” ëª¨ë“œ
                setSnapMargins('clicked');

                // (ì„ íƒ) ì„¸ì…˜2ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™â€”ì´ë¯¸ ë„¤ê°€ ê·¸ë ‡ê²Œ ì“°ê³  ìˆë‹¤ë©´ ìœ ì§€
                const snapDay = document.getElementById('snap-day');
                if (snapDay) snapDay.scrollIntoView({ behavior: 'smooth' });
            });
        })();


    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // ì„¸ì…˜1(#snap-diary) ê¸°ë³¸ì€ header ë§Œí¼ë§Œ
            const snapDiary = document.getElementById("snap-diary");
            if (snapDiary) snapDiary.style.scrollMarginTop = "var(--header-h)";

            // ë‹¬ë ¥ ì¹¸ í´ë¦­ ì‹œ â†’ ì„¸ì…˜1ì— í•­ìƒ header ë§Œí¼ margin ì¶”ê°€
            document.addEventListener("click", (e) => {
                const cell = e.target.closest(".cell");
                if (!cell || cell.classList.contains("off")) return;

                // ì„¸ì…˜1ì—ë§Œ í—¤ë”ë°” ë§Œí¼ margin ë³´ì¥
                if (snapDiary) {
                    snapDiary.style.scrollMarginTop = "var(--header-h)";
                }
            });
        });

        document.addEventListener("DOMContentLoaded", () => {
            const canvas = document.getElementById("canvas");
            const date = document.getElementById("dateBadge")?.textContent || "";

            if (date && canvas) {
                // localStorageì—ì„œ ìº¡ì²˜ëœ ì •ì› ë¶ˆëŸ¬ì˜¤ê¸°
                const capture = localStorage.getItem(`garden_capture_${date}`);
                if (capture && capture.startsWith("data:image")) {
                    canvas.style.backgroundImage = `url(${capture})`;
                    canvas.style.backgroundSize = "cover";
                    canvas.style.backgroundPosition = "center";
                }
            }
        });
        // âœ… ìº¡ì²˜ëœ ì •ì› ì‚¬ì§„ì„ ìº”ë²„ìŠ¤ ë°°ê²½ìœ¼ë¡œ í‘œì‹œ
        function setCanvasFromCapture(dateStr) {
            const canvas = document.getElementById('canvas');
            if (!canvas || !dateStr) return;

            const cap = localStorage.getItem(`garden_capture_${dateStr}`);
            if (cap && cap.startsWith('data:image')) {
                canvas.style.backgroundImage = `url(${cap})`;
                canvas.style.backgroundSize = 'cover';
                canvas.style.backgroundPosition = 'center';
            } else {
                // ì €ì¥ëœ ìº¡ì²˜ê°€ ì—†ìœ¼ë©´ ë°°ê²½ ì œê±°
                canvas.style.backgroundImage = 'none';
            }
        }

    </script>
    <!-- ... ìœ„ìª½ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ë“¤ ... -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // dateBadgeê°€ ì±„ì›Œì§„ ë’¤ í•œ ë²ˆ ë” ë³´ì •
            requestAnimationFrame(() => {
                const date = (document.getElementById('dateBadge')?.textContent || '').trim();
                if (date) setCanvasFromCapture(date);
            });
        });
    </script>
    <!-- === [ADD-OVERRIDE] ì„¸ì…˜1 ì•„ì´ì½˜ ë™ê¸°í™” + ìŠ¤ëƒ… ì—¬ë°± ì¼ì›í™” === -->
    <style>
        /* ì„¸ì…˜1(ì„ë² ë””ë“œ ë‹¬ë ¥)ë„ ì„¸ì…˜2ì²˜ëŸ¼ ì½”ë„ˆ ì•„ì´ì½˜ë¡œ ë³´ì´ê²Œ ì˜¤ë²„ë¼ì´ë“œ */
        #diaryEmbed .thumb-box {
            position: absolute !important;
            right: 3px !important;
            bottom: 3px !important;
            width: auto !important;
            height: auto !important;
            border: none !important;
            padding: 0 !important;
            display: inline-grid !important;
            place-items: center !important;
            background: transparent !important;
            font-size: 16px !important;
            line-height: 1 !important;
            color: var(--gray) !important;
            /* ê¸°ë³¸ íšŒìƒ‰ */
        }

        #diaryEmbed .thumb-box.orange {
            color: var(--orange) !important;
            /* ìº¡ì²˜(ì‚¬ì§„) ìˆìœ¼ë©´ ì˜¤ë Œì§€ */
        }


        /* ì (.) ìˆ¨ê¹€ */

        /* ìŠ¤ëƒ… ì—¬ë°±: ê¸°ë³¸ê°’ì€ CSSì—ì„œ ì§€ì •ë˜ì–´ ìˆìœ¼ë‚˜, ì•„ë˜ JSì—ì„œ ìµœì¢… ì¼ì›í™” */
    </style>

    <script>
        (function () {
            /* =========================
             *  A) ì„¸ì…˜1 ë‹¬ë ¥ ì•„ì´ì½˜ í†µì¼
             *  - diaryEmbed ì˜ ë¹Œë“œëŠ” ê¸°ì¡´ëŒ€ë¡œ ë‘ê³ ,
             *    ë¹Œë“œ ê²°ê³¼ë¬¼(#de_grid) ì•ˆì˜ thumb-box ë‚´ìš©ì„ âœ¿/ìƒ‰ìƒ ê·œì¹™ìœ¼ë¡œ ì •ê·œí™”
             * ========================= */
            function normalizeDiaryMarks() {
                const boxes = document.querySelectorAll('#de_grid .thumb-box');
                boxes.forEach((box) => {
                    // ê¸°ì¡´ ë¹Œë“œê°€ 'âœ¿' (ìº¡ì²˜ æœ‰) ë˜ëŠ” 'Â·'(ìº¡ì²˜ ç„¡)ì„ ë„£ìœ¼ë¯€ë¡œ, ë‚´ìš© ë³´ê³  ìƒ‰ë§Œ ê²°ì •
                    const hasCapture = (box.textContent && box.textContent.indexOf('âœ¿') !== -1);
                    box.textContent = 'âœ¿';                      // ëª¨ë‘ âœ¿ë¡œ í†µì¼
                    box.classList.toggle('orange', hasCapture); // ìº¡ì²˜ë©´ ì˜¤ë Œì§€, ì•„ë‹ˆë©´ íšŒìƒ‰
                });
            }

            // ê·¸ë¦¬ë“œ ë³€í™”ë¥¼ ê°ì§€í•´ ë§¤ë²ˆ ì •ê·œí™”
            const deGrid = document.getElementById('de_grid');
            if (deGrid) {
                const mo = new MutationObserver(() => normalizeDiaryMarks());
                mo.observe(deGrid, { childList: true, subtree: true });
                // ì´ˆê¸° 1íšŒ
                normalizeDiaryMarks();
            }

            /* =========================
             *  B) ìŠ¤ëƒ… ì„¹ì…˜ top ì—¬ë°± ì¼ì›í™”
             *  - ìš”êµ¬ì‚¬í•­:
             *    Â· ì„¸ì…˜1ì€ ë” í° top ì—¬ë°±
             *    Â· ì„¸ì…˜2ëŠ” ë” ì‘ì€ top ì—¬ë°±
             *    Â· ì§ì ‘ ì§„ì…/ë‹¬ë ¥ í´ë¦­ ëª¨ë‘ ê°™ì€ ê²°ê³¼(ì¼ê´€ëœ ë ˆì´ì•„ì›ƒ)
             * ========================= */
            const SNAP1_TOP = 'calc(var(--header-h) + 24px)'; // ì„¸ì…˜1(#snap-diary): header + 24px
            const SNAP2_TOP = 'var(--header-h)';              // ì„¸ì…˜2(#snap-day):   header

            function applyUnifiedMargins() {
                const s1 = document.getElementById('snap-diary');
                const s2 = document.getElementById('snap-day');
                const vp = document.querySelector('.snap-viewport');

                if (s1) s1.style.scrollMarginTop = SNAP1_TOP;
                if (s2) s2.style.scrollMarginTop = SNAP2_TOP;

                // ìŠ¤ëƒ… ê¸°ì¤€ì€ ë³´í†µ í˜„ì¬ ë³´ì´ëŠ” ì„¹ì…˜ ê¸°ì¤€ìœ¼ë¡œ ë§ì¶”ëŠ” ê²Œ ë¶€ë“œëŸ¬ì›€: ì„¸ì…˜2 ê¸°ì¤€(ì‘ì€ ê°’)ìœ¼ë¡œ ë‘ 
                if (vp) vp.style.scrollPaddingTop = SNAP2_TOP;
            }

            // 1) í˜ì´ì§€ ì§ì ‘ ì—´ì—ˆì„ ë•Œ
            document.addEventListener('DOMContentLoaded', applyUnifiedMargins);

            // 2) ë‹¬ë ¥ ì¹¸(.cell) í´ë¦­ìœ¼ë¡œ ì´ë™í•´ë„ ë™ì¼í•˜ê²Œ ìœ ì§€ (ì„¸ì…˜1/2 ë‚´ë¶€ ìº˜ë¦°ë” ëª¨ë‘ ìœ„ì„)
            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.cell');
                if (!cell) return;
                const inCalendar = cell.closest('#de_grid, #calGrid');
                if (!inCalendar) return;
                // ì´ë™ ì „ì— í•œë²ˆ ë” ë³´ì •(ë§Œì¼ì˜ ë ˆì´ìŠ¤ì»¨ë””ì…˜ ë°©ì§€)
                applyUnifiedMargins();
            });

        })();
    </script>
    <!-- === [/ADD-OVERRIDE] ë === -->
    <!-- === [ADD-OVERRIDE] ì„¸ì…˜1 ì•„ì´ì½˜ âœ¿ ë™ê¸°í™” + ìŠ¤ëƒ…/ìŠ¤í¬ë¡¤ ë³´ì • === -->
    <style>
        /* (ì•ˆì „ì¥ì¹˜) ì„¸ì…˜1ì—ë„ mark-flower ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ë„ë¡ í¬ê¸°ë§Œ ì‚´ì§ í†µì¼ */
        #diaryEmbed .mark-flower {
            position: absolute;
            right: 3px;
            bottom: 3px;
            font-size: 16px;
            line-height: 1;
        }
    </style>
    <script>
        (function () {
            /* ---------------------------
             * A) ì„¸ì…˜1 ì•„ì´ì½˜ êµì²´: thumb-box â†’ âœ¿.mark-flower
             * --------------------------- */
            function replaceThumbsWithMarks() {
                const cells = document.querySelectorAll('#de_grid .cell');
                cells.forEach(cell => {
                    const box = cell.querySelector('.thumb-box');
                    if (!box) return;
                    const hasCapture = (box.textContent && box.textContent.indexOf('âœ¿') !== -1);
                    box.remove();

                    const span = document.createElement('span');
                    span.className = 'mark-flower' + (hasCapture ? ' orange' : '');
                    span.textContent = 'âœ¿';
                    cell.appendChild(span);
                });
            }

            // de_gridê°€ ë‹¤ì‹œ ë¹Œë“œë  ë•Œë§ˆë‹¤ ìë™ êµì²´
            const deGrid = document.getElementById('de_grid');
            if (deGrid) {
                const mo = new MutationObserver(() => replaceThumbsWithMarks());
                mo.observe(deGrid, { childList: true, subtree: true });
                // ì´ˆê¸° 1íšŒ
                replaceThumbsWithMarks();
            }

            /* ---------------------------
             * B) ìŠ¤ëƒ…/ì—¬ë°± ê·œì¹™ ê³ ì •
             *   - ì„¸ì…˜1: header + 24px
             *   - ì„¸ì…˜2: header
             * --------------------------- */
            function applySnapMargins() {
                const s1 = document.getElementById('snap-diary');
                const s2 = document.getElementById('snap-day');
                const vp = document.querySelector('.snap-viewport');
                if (s1) s1.style.scrollMarginTop = 'calc(var(--header-h) + 24px)';
                if (s2) s2.style.scrollMarginTop = 'var(--header-h)';
                if (vp) vp.style.scrollPaddingTop = 'var(--header-h)';
            }
            document.addEventListener('DOMContentLoaded', applySnapMargins);

            /* ---------------------------
             * C) ë‹¬ë ¥ ë‚ ì§œ í´ë¦­ ì‹œ:
             *   - ì„¸ì…˜2ë¡œ ìŠ¤ë¬´ìŠ¤ ì´ë™
             *   - ì‚´ì§ ë” ì•„ë˜ë¡œ(ì˜¤í”„ì…‹) ë‚´ë ¤ì£¼ê¸°
             * --------------------------- */
            function smoothGoToSession2WithOffset() {
                const vp = document.querySelector('.snap-viewport');
                const target = document.getElementById('snap-day');
                if (!target) return;
                // ë¨¼ì € ì„¸ì…˜2ì˜ ì‹œì‘ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // ì•½ê°„ì˜ ì˜¤í”„ì…‹(ì•„ë˜ë¡œ 24px) ì¶”ê°€
                setTimeout(() => {
                    if (vp) vp.scrollBy({ top: 24, left: 0, behavior: 'smooth' });
                }, 280);

            }

            // ì„¸ì…˜1/ì„¸ì…˜2 ë‹¬ë ¥ì˜ ë‚ ì§œ í´ë¦­ ëª¨ë‘ì— ì ìš©
            document.addEventListener('click', (e) => {
                const cell = e.target.closest('.cell');
                if (!cell || cell.classList.contains('off')) return;

                // (ê°€ë…ì„±) ì—¬ë°± ê·œì¹™ í•œë²ˆ ë” ë³´ì •
                applySnapMargins();

                // ë‚ ì§œ í´ë¦­ì´ë©´ ì„¸ì…˜2ë¡œ ì´ë™ + ì‚´ì§ ë” ì•„ë˜
                // (ì„¸ì…˜1 í° ë‹¬ë ¥(#de_grid) or ì„¸ì…˜2 ë¯¸ë‹ˆ ë‹¬ë ¥(#calGrid) ëª¨ë‘ í¬í•¨)
                if (cell.closest('#de_grid, #calGrid')) {
                    smoothGoToSession2WithOffset();
                }
            });
        })();
    </script>
    <!-- === [/ADD-OVERRIDE] ë === -->
    <script>
        // ë‹¬ë ¥ ë°‘ ë©”ëª¨ ë°•ìŠ¤ ë Œë”ë§ í•¨ìˆ˜
        function renderMiniDetails(dateStr) {
            const box = document.querySelector('.mini-details');
            if (!box) return;

            const raw = DataBridge.readAny(dateStr); // today.html ë°ì´í„° ì½ê¸°
            box.innerHTML = ''; // ì´ˆê¸°í™”

            if (!raw || (!raw.quote && !raw.flower && (!raw.props || !raw.props.length))) {
                box.innerHTML = '<p style="font-size:13px;color:#888">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.</p>';
                return;
            }

            // ê¸°ë¶„ í•œ ì¤„
            if (raw.quote) {
                const row = document.createElement('div');
                row.className = 'md-row';
                row.innerHTML = `<div class="md-label">í•œ ì¤„</div><div class="md-val">${raw.quote}</div>`;
                box.appendChild(row);
            }

            // í‚¤ì›Œë“œ
            if (raw.keywords && raw.keywords.length) {
                const row = document.createElement('div');
                row.className = 'md-row';
                row.innerHTML = `<div class="md-label">í‚¤ì›Œë“œ</div><div class="md-val chips" id="mdKeywords"></div>`;
                box.appendChild(row);

                raw.keywords.forEach(k => {
                    const chip = document.createElement('div');
                    chip.className = 'chip';
                    chip.textContent = k.label || k;
                    row.querySelector('#mdKeywords').appendChild(chip);
                });
            }

            // ì„ íƒí•œ ê½ƒ
            if (raw.flower) {
                const row = document.createElement('div');
                row.className = 'md-row';
                row.innerHTML = `<div class="md-label">ì˜¤ëŠ˜ ê½ƒ</div>
                             <div class="md-val">${raw.flower.name || EN_NAME[raw.flower.id] || ''}</div>`;
                box.appendChild(row);
            }

            // ì†Œí’ˆ/ë‚ ì”¨
            if (raw.props && raw.props.length) {
                const row = document.createElement('div');
                row.className = 'md-row';
                row.innerHTML = `<div class="md-label">ì†Œí’ˆ</div>
                             <div class="md-val">${raw.props.map(p => p.name || p).join(', ')}</div>`;
                box.appendChild(row);
            }
        }

        // ê¸°ì¡´ loadForDate ì•ˆì—ì„œ í˜¸ì¶œë˜ë„ë¡ ì—°ê²°
        const _oldLoadForDate = loadForDate;
        loadForDate = function (dateStr) {
            _oldLoadForDate(dateStr);  // ê¸°ì¡´ ì¹´ë“œ ë Œë”
            renderMiniDetails(dateStr); // ë‹¬ë ¥ ë°‘ ë©”ëª¨ë„ ê°±ì‹ 
        };

        // í˜ì´ì§€ ì²« ë¡œë”© ì‹œ ê¸°ë³¸ ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            const def = DataBridge.bestDate();
            renderMiniDetails(def);
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¹´ë“œ/ì •ì› ë¶ˆëŸ¬ì˜¤ê¸°
            if (typeof loadForDate === "function") {
                loadForDate(todayStr);
            }

            // ë‹¬ë ¥ì—ì„œ ì˜¤ëŠ˜ ì…€ ì„ íƒ í‘œì‹œ
            const calGrid = document.getElementById("calGrid");
            if (calGrid) {
                const todayCell = Array.from(calGrid.querySelectorAll(".cell"))
                    .find(c => c.textContent.trim() === String(today.getDate()));
                if (todayCell) {
                    calGrid.querySelectorAll(".cell.sel").forEach(c => c.classList.remove("sel"));
                    todayCell.classList.add("sel");
                }
            }

            // dateBadge ê°±ì‹ 
            const dateBadge = document.getElementById("dateBadge");
            if (dateBadge) {
                dateBadge.textContent = todayStr;
            }

            // ìƒë‹¨ í—¤ë“œë¼ì¸ ë‚ ì§œë„ ê°±ì‹ 
            if (typeof syncHeadline === "function") {
                syncHeadline(todayStr);
            }
        });
    </script>
    <!-- HTML (ì˜ˆì‹œ: ì„ íƒìë§Œ ë§ì¶° ì“°ì„¸ìš”) -->
    <div id="gardenEditor">
        <div id="gardenStage">
            <!-- ì˜¤ë¸Œì íŠ¸ë“¤ì´ ì´ ì•ˆì— append ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <style>
        /* í¸ì§‘ ë°•ìŠ¤ UI */
        .edit-box {
            position: absolute;
            border: 2px dashed rgba(0, 0, 0, 0.35);
            border-radius: 10px;
            pointer-events: none;
            /* í´ë¦­ì€ ëŒ€ìƒ ì˜¤ë¸Œì íŠ¸ê°€ ë°›ê²Œ */
            z-index: 9999;
            box-sizing: border-box;
            outline: 1px solid rgba(255, 255, 255, 0.6);
            outline-offset: -4px;
        }

        .edit-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #fff;
            border: 2px solid rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: auto;
            /* í•¸ë“¤ì€ ì§ì ‘ ì¡ì„ ìˆ˜ ìˆê²Œ */
            cursor: nwse-resize;
        }

        .edit-handle.tl {
            top: 0%;
            left: 0%;
        }

        .edit-handle.tr {
            top: 0%;
            left: 100%;
        }

        .edit-handle.bl {
            top: 100%;
            left: 0%;
        }

        .edit-handle.br {
            top: 100%;
            left: 100%;
        }

        .edit-delete {
            position: absolute;
            top: -16px;
            right: -16px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #ff4d4f;
            color: #fff;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            pointer-events: auto;
            /* ì‚­ì œ ë²„íŠ¼ì€ í´ë¦­ ê°€ëŠ¥ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        /* Stage ì•ˆ ì˜¤ë¸Œì íŠ¸ ê³µí†µ í´ë˜ìŠ¤ (í•„ìˆ˜) */
        #gardenStage .g-obj {
            position: absolute;
            /* ììœ  ë°°ì¹˜ ê°€ì • */
            transform-origin: center center;
            user-select: none;
            cursor: pointer;
        }
    </style>

    <script>
        (() => {
            // === ì„ íƒì: í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ë°”ê¾¸ì„¸ìš” ===
            const editor = document.getElementById('gardenEditor');
            const stage = document.getElementById('gardenStage');
            const btnClear = document.getElementById('btnClearGarden');

            // ---------------------------
            // Selection UI (ì¬ì‚¬ìš© 1ê°œë§Œ)
            // ---------------------------
            const Selection = {
                box: null,
                target: null,

                ensure() {
                    if (this.box) return;
                    const box = document.createElement('div');
                    box.className = 'edit-box';
                    box.style.display = 'none';

                    // í•¸ë“¤ 4ê°œ
                    ['tl', 'tr', 'bl', 'br'].forEach(pos => {
                        const h = document.createElement('div');
                        h.className = 'edit-handle ' + pos;
                        box.appendChild(h);
                    });

                    // ì‚­ì œ ë²„íŠ¼ (ìš”ì²­í•˜ì…¨ë˜ Xí‘œì‹œ)
                    const del = document.createElement('button');
                    del.className = 'edit-delete';
                    del.type = 'button';
                    del.innerText = 'Ã—';
                    del.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (this.target && this.target.parentNode) {
                            this.target.parentNode.removeChild(this.target);
                        }
                        this.clear(); // ëŒ€ìƒ ì‚¬ë¼ì¡Œìœ¼ë‹ˆ í¸ì§‘íˆ´ ìˆ¨ê¹€
                    });
                    box.appendChild(del);

                    editor.appendChild(box);
                    this.box = box;

                    // (ì„ íƒ) ë¦¬ì‚¬ì´ì¦ˆ/ë“œë˜ê·¸ ë¡œì§ì„ ì´ë¯¸ ê°–ê³  ê³„ì‹œë©´ ì—¬ê¸°ì— ì—°ê²°í•˜ì„¸ìš”.
                    // ì—¬ê¸°ì„œëŠ” í¸ì§‘í‹€ "ë‹¤ì‹œ ëœ¨ëŠ”" ë™ì‘ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.
                },

                attach(el) {
                    this.ensure();
                    this.target = el;
                    this.updatePosition();
                    this.box.style.display = 'block';
                },

                clear() {
                    this.target = null;
                    if (this.box) this.box.style.display = 'none';
                },

                updatePosition() {
                    if (!this.box || !this.target) return;
                    // ì—ë””í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ íƒ€ê¹ƒì˜ ìœ„ì¹˜/í¬ê¸° ê³„ì‚°
                    const editorRect = editor.getBoundingClientRect();
                    const rect = this.target.getBoundingClientRect();
                    const left = rect.left - editorRect.left + editor.scrollLeft;
                    const top = rect.top - editorRect.top + editor.scrollTop;

                    this.box.style.left = left + 'px';
                    this.box.style.top = top + 'px';
                    this.box.style.width = rect.width + 'px';
                    this.box.style.height = rect.height + 'px';
                }
            };

            // ìŠ¤í¬ë¡¤/ë¦¬ì‚¬ì´ì¦ˆì—ë„ ë°•ìŠ¤ ìœ„ì¹˜ ë³´ì •
            window.addEventListener('resize', () => Selection.updatePosition(), { passive: true });
            editor.addEventListener('scroll', () => Selection.updatePosition(), { passive: true });

            // --------------------------------
            // 1) ì •ì› í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„ (í•µì‹¬)
            // --------------------------------
            stage.addEventListener('click', (e) => {
                const obj = e.target.closest('.g-obj');
                if (!obj) return;           // ë¹ˆ ê³³ í´ë¦­ì´ë©´ ë¬´ì‹œ
                Selection.attach(obj);      // í¸ì§‘íˆ´ "ë¶™ì´ê¸°"
            });

            // --------------------------------
            // 2) "ë¹„ìš°ê¸°" ë™ì‘ (í•µì‹¬)
            // --------------------------------
            btnClear.addEventListener('click', () => {
                stage.innerHTML = '';        // ì •ì› ì˜¤ë¸Œì íŠ¸ ì „ì²´ ì œê±°
                Selection.clear();           // í¸ì§‘íˆ´ì€ íŒŒê´´í•˜ì§€ ë§ê³  "ìˆ¨ê¹€"ë§Œ!
            });

            // --------------------------------
            // 3) íŒ”ë ˆíŠ¸ì—ì„œ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€ ì˜ˆì‹œ
            //    (ì¶”ê°€ í›„ ì¦‰ì‹œ í´ë¦­í•˜ë©´ í¸ì§‘íˆ´ì´ ë‹¤ì‹œ ëœ¸)
            // --------------------------------
            document.querySelectorAll('.palette').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ì˜ˆì‹œ ì˜¤ë¸Œì íŠ¸ ìƒì„±
                    const kind = btn.dataset.kind || 'obj';
                    const el = document.createElement('div');
                    el.className = 'g-obj';
                    el.textContent = kind === 'flower' ? 'ğŸŒ¸' : kind === 'stone' ? 'ğŸª¨' : 'ğŸ§©';

                    // ì„ì‹œ ìœ„ì¹˜/í¬ê¸° (í”„ë¡œì íŠ¸ ë¡œì§ëŒ€ë¡œ ë°°ì¹˜í•˜ì„¸ìš”)
                    const x = 40 + Math.random() * 200;
                    const y = 40 + Math.random() * 120;
                    el.style.left = x + 'px';
                    el.style.top = y + 'px';
                    el.style.fontSize = '48px';

                    stage.appendChild(el);

                    // ë°©ê¸ˆ ì¶”ê°€í•œ ê±¸ ë°”ë¡œ ì„ íƒ ìƒíƒœë¡œ ë§Œë“¤ê³  ì‹¶ë‹¤ë©´:
                    Selection.attach(el);
                });
            });

            // --------------------------------
            // 4) ì™¸ë¶€ì—ì„œ ì˜¤ë¸Œì íŠ¸ê°€ ì¶”ê°€/ì´ë™/ë¦¬ì‚¬ì´ì¦ˆ ë˜ì–´ë„
            //    í¸ì§‘í‹€ ìœ„ì¹˜ê°€ ë°”ë¡œ ë°˜ì˜ë˜ë„ë¡ ì˜µì €ë²„ (ì„ íƒ)
            // --------------------------------
            const mo = new MutationObserver(() => Selection.updatePosition());
            mo.observe(stage, { attributes: true, childList: true, subtree: true });
        })();
    </script>


</body>

</html>